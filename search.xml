<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>注册中心对比</title>
      <link href="/posts/35980.html"/>
      <url>/posts/35980.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>mq对比</title>
      <link href="/posts/28636.html"/>
      <url>/posts/28636.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot事务实现原理</title>
      <link href="/posts/37393.html"/>
      <url>/posts/37393.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>HikariCP 连接池详解</title>
      <link href="/posts/35254.html"/>
      <url>/posts/35254.html</url>
      
        <content type="html"><![CDATA[<h1 id="HikariCP-连接池详解"><a href="#HikariCP-连接池详解" class="headerlink" title="HikariCP 连接池详解"></a>HikariCP 连接池详解</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol><li><a href="#核心概念">核心概念</a></li><li><a href="#连接获取流程">连接获取流程</a></li><li><a href="#连接归还流程">连接归还流程</a></li><li><a href="#concurrentbag-三层查找机制">ConcurrentBag 三层查找机制</a></li><li><a href="#关键组件详解">关键组件详解</a></li><li><a href="#常见问题解答">常见问题解答</a></li><li><a href="#设计决策分析">设计决策分析</a></li></ol><hr><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="1-基本组件"><a href="#1-基本组件" class="headerlink" title="1. 基本组件"></a>1. 基本组件</h3><h4 id="Connection（真实连接）"><a href="#Connection（真实连接）" class="headerlink" title="Connection（真实连接）"></a>Connection（真实连接）</h4><ul><li>数据库驱动提供的真实 JDBC 连接</li><li>例如 MySQL 的 <code>com.mysql.cj.jdbc.ConnectionImpl</code></li><li>直接与数据库通信</li></ul><h4 id="PoolEntry（连接条目）"><a href="#PoolEntry（连接条目）" class="headerlink" title="PoolEntry（连接条目）"></a>PoolEntry（连接条目）</h4><ul><li>连接池内部用来管理连接的包装类</li><li>每个 <code>PoolEntry</code> 唯一对应一个真实的 <code>Connection</code></li><li>包含连接的状态、时间戳等信息</li></ul><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PoolEntry</span> <span class="token keyword">implements</span> <span class="token class-name">IConcurrentBagEntry</span> <span class="token punctuation">{</span>    Connection connection<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 真实连接</span>    <span class="token keyword">long</span> lastAccessed<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 最后访问时间</span>    <span class="token keyword">long</span> lastBorrowed<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 最后借出时间</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 状态（空闲/使用中/已移除等）</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> evict<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 是否被标记驱逐</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ProxyConnection（代理连接）"><a href="#ProxyConnection（代理连接）" class="headerlink" title="ProxyConnection（代理连接）"></a>ProxyConnection（代理连接）</h4><ul><li>应用层拿到的连接对象</li><li>内部持有 <code>PoolEntry</code> 和真实 <code>Connection</code></li><li>拦截 <code>close()</code> 等方法，将连接归还池中而不是真正关闭</li></ul><h4 id="ConcurrentBag（连接袋）"><a href="#ConcurrentBag（连接袋）" class="headerlink" title="ConcurrentBag（连接袋）"></a>ConcurrentBag（连接袋）</h4><ul><li>存放 <code>PoolEntry</code> 的容器</li><li>提供 <code>borrow()</code> 和 <code>requite()</code> 方法</li><li>使用线程本地缓存和共享列表，减少锁竞争</li></ul><h4 id="bagEntry"><a href="#bagEntry" class="headerlink" title="bagEntry"></a>bagEntry</h4><ul><li><code>bagEntry</code> 就是 <code>PoolEntry</code></li><li>在 <code>ConcurrentBag</code> 的方法里，参数名用 <code>bagEntry</code> 表示”袋子里的条目”</li></ul><h3 id="2-关系图"><a href="#2-关系图" class="headerlink" title="2. 关系图"></a>2. 关系图</h3><pre><code>应用代码   ↓ 调用 getConnection()HikariPool   ↓ 从 ConcurrentBag 借出PoolEntry (bagEntry)   ↓ 包装成ProxyConnection   ↓ 返回给应用应用拿到 ProxyConnection，但实际使用的是 PoolEntry 里的真实 Connection</code></pre><hr><h2 id="连接获取流程"><a href="#连接获取流程" class="headerlink" title="连接获取流程"></a>连接获取流程</h2><h3 id="1-入口方法"><a href="#1-入口方法" class="headerlink" title="1. 入口方法"></a>1. 入口方法</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Connection <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> hardTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>    suspendResumeLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> timeout <span class="token operator">=</span> hardTimeout<span class="token punctuation">;</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 从 ConcurrentBag 借出 PoolEntry</span>            PoolEntry poolEntry <span class="token operator">=</span> connectionBag<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>poolEntry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 超时</span>            <span class="token punctuation">}</span>            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 健康检查</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span><span class="token function">isMarkedEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>                 <span class="token punctuation">(</span><span class="token function">elapsedMillis</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>lastAccessed<span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">></span> aliveBypassWindowMs                  <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isConnectionAlive</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>connection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 连接不可用，关闭并重试</span>                <span class="token function">closeConnection</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                timeout <span class="token operator">=</span> hardTimeout <span class="token operator">-</span> <span class="token function">elapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 连接可用，创建代理连接返回</span>                metricsTracker<span class="token punctuation">.</span><span class="token function">recordBorrowStats</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> poolEntry<span class="token punctuation">.</span><span class="token function">createProxyConnection</span><span class="token punctuation">(</span>                    leakTaskFactory<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>timeout <span class="token operator">></span> 0L<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 超时，抛出异常</span>        metricsTracker<span class="token punctuation">.</span><span class="token function">recordBorrowTimeoutStats</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> <span class="token function">createTimeoutException</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        suspendResumeLock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-关键步骤"><a href="#2-关键步骤" class="headerlink" title="2. 关键步骤"></a>2. 关键步骤</h3><ol><li><strong>获取 suspendResumeLock</strong>：确保池未被挂起</li><li><strong>从 ConcurrentBag 借出</strong>：三层查找机制（见下文）</li><li><strong>健康检查</strong>：<ul><li>检查是否被标记驱逐</li><li>检查连接是否存活（超过 <code>aliveBypassWindowMs</code> 需要检测）</li></ul></li><li><strong>创建代理连接</strong>：包装成 <code>ProxyConnection</code> 并启动泄漏检测</li><li><strong>返回给应用</strong>：应用获得代理连接</li></ol><hr><h2 id="连接归还流程"><a href="#连接归还流程" class="headerlink" title="连接归还流程"></a>连接归还流程</h2><h3 id="1-应用调用-close"><a href="#1-应用调用-close" class="headerlink" title="1. 应用调用 close()"></a>1. 应用调用 close()</h3><pre class="line-numbers language-java"><code class="language-java">connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 应用代码</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-ProxyConnection-拦截-close"><a href="#2-ProxyConnection-拦截-close" class="headerlink" title="2. ProxyConnection 拦截 close()"></a>2. ProxyConnection 拦截 close()</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1. 关闭所有 Statement</span>    <span class="token function">closeStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate <span class="token operator">!=</span> ClosedConnection<span class="token punctuation">.</span>CLOSED_CONNECTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 2. 取消泄漏检测任务</span>        leakTask<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 3. 清理连接状态</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isCommitStateDirty <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isAutoCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>                delegate<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>dirtyBits <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                poolEntry<span class="token punctuation">.</span><span class="token function">resetConnectionState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dirtyBits<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            delegate<span class="token punctuation">.</span><span class="token function">clearWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poolEntry<span class="token punctuation">.</span><span class="token function">isMarkedEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token function">checkException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 4. 归还连接</span>            delegate <span class="token operator">=</span> ClosedConnection<span class="token punctuation">.</span>CLOSED_CONNECTION<span class="token punctuation">;</span>            poolEntry<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>lastAccess<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-调用链"><a href="#3-调用链" class="headerlink" title="3. 调用链"></a>3. 调用链</h3><pre><code>ProxyConnection.close()    ↓ 调用 poolEntry.recycle(lastAccess)PoolEntry.recycle()    ↓ 调用 hikariPool.recycle(this)HikariPool.recycle()    ↓ 调用 connectionBag.requite(poolEntry)ConcurrentBag.requite()    ↓ 执行 threadLocalList.add(bagEntry) 或放入 handoffQueue连接被归还到池中 ✓</code></pre><h3 id="4-requite-方法详解"><a href="#4-requite-方法详解" class="headerlink" title="4. requite() 方法详解"></a>4. requite() 方法详解</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requite</span><span class="token punctuation">(</span><span class="token keyword">final</span> T bagEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1. 设置状态为空闲</span>    bagEntry<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 2. 如果有等待线程，优先放入 handoffQueue 直接交付</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> waiters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> STATE_NOT_IN_USE <span class="token operator">||</span>             handoffQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>bagEntry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 重试逻辑...</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 3. 否则放入线程本地列表（最多50个）</span>    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Object<span class="token operator">></span> threadLocalList <span class="token operator">=</span> threadList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadLocalList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        threadLocalList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>weakThreadLocals <span class="token operator">?</span>             <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>bagEntry<span class="token punctuation">)</span> <span class="token operator">:</span> bagEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="ConcurrentBag-三层查找机制"><a href="#ConcurrentBag-三层查找机制" class="headerlink" title="ConcurrentBag 三层查找机制"></a>ConcurrentBag 三层查找机制</h2><h3 id="第一层：线程本地列表（threadList）"><a href="#第一层：线程本地列表（threadList）" class="headerlink" title="第一层：线程本地列表（threadList）"></a>第一层：线程本地列表（threadList）</h3><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Try the thread-local list first</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>Object<span class="token operator">></span> list <span class="token operator">=</span> threadList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> Object entry <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> T bagEntry <span class="token operator">=</span> weakThreadLocals <span class="token operator">?</span>         <span class="token punctuation">(</span><span class="token punctuation">(</span>WeakReference<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> entry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> entry<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>         bagEntry<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">,</span> STATE_IN_USE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> bagEntry<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul><li><strong>ThreadLocal 存储</strong>：每个线程有独立的列表，互不干扰</li><li><strong>从后往前遍历</strong>：优先取最近归还的连接</li><li><strong>CAS 状态切换</strong>：使用 <code>compareAndSet</code> 原子操作</li><li><strong>无锁设计</strong>：线程只访问自己的列表，无需同步</li></ul><h4 id="为什么优先使用？"><a href="#为什么优先使用？" class="headerlink" title="为什么优先使用？"></a>为什么优先使用？</h4><ul><li>✅ 无锁：线程只访问自己的列表，无需同步</li><li>✅ 缓存局部性：CPU 缓存命中率高</li><li>✅ 减少竞争：避免多线程争用共享资源</li></ul><h4 id="为什么是-List-而不是单个连接？"><a href="#为什么是-List-而不是单个连接？" class="headerlink" title="为什么是 List 而不是单个连接？"></a>为什么是 List 而不是单个连接？</h4><p>虽然大多数情况下线程只需要一个连接，但：</p><ol><li><strong>连接复用缓存</strong>：归还后可能很快又要用，缓存起来快速获取</li><li><strong>支持嵌套场景</strong>：一个线程可能需要多个连接（嵌套事务、并行查询）</li><li><strong>限制在50个</strong>：防止无限增长</li></ol><h3 id="第二层：共享列表（sharedList）"><a href="#第二层：共享列表（sharedList）" class="headerlink" title="第二层：共享列表（sharedList）"></a>第二层：共享列表（sharedList）</h3><h4 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Otherwise, scan the shared list</span><span class="token keyword">final</span> <span class="token keyword">int</span> waiting <span class="token operator">=</span> waiters<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>T bagEntry <span class="token operator">:</span> sharedList<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">,</span> STATE_IN_USE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 如果等待线程数 > 1，触发补偿创建</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>waiting <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                listener<span class="token punctuation">.</span><span class="token function">addBagItem</span><span class="token punctuation">(</span>waiting <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> bagEntry<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 没有可用连接，触发创建新连接</span>    listener<span class="token punctuation">.</span><span class="token function">addBagItem</span><span class="token punctuation">(</span>waiting<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    waiters<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h4><ul><li><strong>共享资源</strong>：所有线程共享的 <code>CopyOnWriteArrayList</code></li><li><strong>线性扫描</strong>：遍历查找空闲连接</li><li><strong>CAS 竞争</strong>：多个线程可能同时尝试获取同一连接</li><li><strong>补偿机制</strong>：如果等待线程数 &gt; 1，触发创建新连接</li></ul><h4 id="关键变量"><a href="#关键变量" class="headerlink" title="关键变量"></a>关键变量</h4><ul><li><strong>sharedList</strong>：存储所有连接的全局列表</li><li><strong>waiters</strong>：统计当前等待连接的线程数</li><li><strong>listener</strong>：回调接口，当需要创建新连接时通知外部</li></ul><h3 id="第三层：等待队列（handoffQueue）"><a href="#第三层：等待队列（handoffQueue）" class="headerlink" title="第三层：等待队列（handoffQueue）"></a>第三层：等待队列（handoffQueue）</h3><h4 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 阻塞等待新连接</span>timeout <span class="token operator">=</span> timeUnit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> T bagEntry <span class="token operator">=</span> handoffQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry <span class="token operator">==</span> null <span class="token operator">||</span>         bagEntry<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">,</span> STATE_IN_USE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> bagEntry<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    timeout <span class="token operator">-=</span> <span class="token function">elapsedNanos</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>timeout <span class="token operator">></span> 10_000<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h4><ul><li><strong>SynchronousQueue</strong>：无缓冲队列，生产者必须等待消费者</li><li><strong>阻塞等待</strong>：在超时内等待新连接</li><li><strong>直接交付</strong>：连接归还时如果有等待线程，直接放入队列</li></ul><h4 id="为什么需要？"><a href="#为什么需要？" class="headerlink" title="为什么需要？"></a>为什么需要？</h4><ul><li>当前无可用连接时，避免忙等待</li><li>连接归还时直接交付，减少唤醒延迟</li></ul><hr><h2 id="关键组件详解"><a href="#关键组件详解" class="headerlink" title="关键组件详解"></a>关键组件详解</h2><h3 id="1-aliveBypassWindowMs（健康检查窗口）"><a href="#1-aliveBypassWindowMs（健康检查窗口）" class="headerlink" title="1. aliveBypassWindowMs（健康检查窗口）"></a>1. aliveBypassWindowMs（健康检查窗口）</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> aliveBypassWindowMs <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>    <span class="token string">"com.zaxxer.hikari.aliveBypassWindowMs"</span><span class="token punctuation">,</span>     MILLISECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ul><li>默认 500ms 的时间窗口</li><li>在这个窗口内再次借出同一连接时，可以跳过昂贵的 <code>isConnectionAlive</code> 检查</li><li>超过窗口时间，需要重新检测连接是否存活</li></ul><h4 id="判断逻辑"><a href="#判断逻辑" class="headerlink" title="判断逻辑"></a>判断逻辑</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">elapsedMillis</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>lastAccessed<span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">></span> aliveBypassWindowMs     <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isConnectionAlive</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>connection<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 连接可能已失效，关闭并重试</span>    <span class="token function">closeConnection</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">,</span> DEAD_CONNECTION_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-isMarkedEvicted-（驱逐标记）"><a href="#2-isMarkedEvicted-（驱逐标记）" class="headerlink" title="2. isMarkedEvicted()（驱逐标记）"></a>2. isMarkedEvicted()（驱逐标记）</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">boolean</span> <span class="token function">isMarkedEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> evict<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">markEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>evict <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h4><ul><li>标记连接需要被驱逐</li><li>当连接被标记后，下次借出时会立即关闭</li></ul><h4 id="连接被淘汰的原因"><a href="#连接被淘汰的原因" class="headerlink" title="连接被淘汰的原因"></a>连接被淘汰的原因</h4><ol><li><strong>生命周期到期</strong>：超过 <code>maxLifetime</code></li><li><strong>空闲超时</strong>：超过 <code>idleTimeout</code></li><li><strong>健康检查失败</strong>：连接已失效</li><li><strong>显式驱逐</strong>：调用 <code>softEvictConnections()</code></li><li><strong>异常状态</strong>：连接状态异常</li></ol><h3 id="3-ProxyConnection-创建机制"><a href="#3-ProxyConnection-创建机制" class="headerlink" title="3. ProxyConnection 创建机制"></a>3. ProxyConnection 创建机制</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">return</span> poolEntry<span class="token punctuation">.</span><span class="token function">createProxyConnection</span><span class="token punctuation">(</span>    leakTaskFactory<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><ol><li><strong>不创建新连接</strong>：<code>PoolEntry</code> 里已有真实连接</li><li><strong>创建代理对象</strong>：包装成 <code>ProxyConnection</code></li><li><strong>注册泄漏检测</strong>：启动定时任务监控连接是否泄漏</li></ol><h4 id="为什么需要代理？"><a href="#为什么需要代理？" class="headerlink" title="为什么需要代理？"></a>为什么需要代理？</h4><ul><li>拦截 <code>close()</code> 方法，归还到池中而不是真正关闭</li><li>跟踪 Statement，确保正确关闭</li><li>重置连接状态，保证连接可复用</li></ul><h3 id="4-泄漏检测机制"><a href="#4-泄漏检测机制" class="headerlink" title="4. 泄漏检测机制"></a>4. 泄漏检测机制</h3><h4 id="工作原理-3"><a href="#工作原理-3" class="headerlink" title="工作原理"></a>工作原理</h4><ul><li>配置 <code>leakDetectionThreshold</code>（毫秒）</li><li>每次借出连接时启动 <code>ProxyLeakTask</code></li><li>如果在该时间内连接未归还，记录警告日志</li></ul><h4 id="如何定位问题？"><a href="#如何定位问题？" class="headerlink" title="如何定位问题？"></a>如何定位问题？</h4><ul><li>日志包含借出时的调用栈</li><li>通过堆栈信息定位哪段代码忘记 <code>close()</code></li></ul><h3 id="5-构建阶段代码生成"><a href="#5-构建阶段代码生成" class="headerlink" title="5. 构建阶段代码生成"></a>5. 构建阶段代码生成</h3><h4 id="为什么需要？-1"><a href="#为什么需要？-1" class="headerlink" title="为什么需要？"></a>为什么需要？</h4><ul><li><code>ProxyFactory</code> 源码中只有占位方法</li><li>真正的代理类在构建时由 <code>JavassistProxyFactory</code> 生成</li><li>生成专用的字节码代理，性能优于 JDK 动态代理</li></ul><h4 id="构建配置"><a href="#构建配置" class="headerlink" title="构建配置"></a>构建配置</h4><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.codehaus.mojo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>exec-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arguments</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span><span class="token punctuation">></span></span>-cp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argument</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argument</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span><span class="token punctuation">></span></span>com.zaxxer.hikari.util.JavassistProxyFactory<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argument</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arguments</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="常见问题解答"><a href="#常见问题解答" class="headerlink" title="常见问题解答"></a>常见问题解答</h2><h3 id="Q1-为什么线程本地列表是-List-而不是单个连接？"><a href="#Q1-为什么线程本地列表是-List-而不是单个连接？" class="headerlink" title="Q1: 为什么线程本地列表是 List 而不是单个连接？"></a>Q1: 为什么线程本地列表是 List 而不是单个连接？</h3><p><strong>A:</strong> 虽然大多数情况下线程只需要一个连接，但：</p><ol><li><strong>连接复用缓存</strong>：归还后可能很快又要用</li><li><strong>支持嵌套场景</strong>：一个线程可能需要多个连接</li><li><strong>限制在50个</strong>：防止无限增长</li></ol><p>实际运行中，线程本地列表通常只有 0-2 个连接。</p><h3 id="Q2-requite-怎么读？是什么意思？"><a href="#Q2-requite-怎么读？是什么意思？" class="headerlink" title="Q2: requite 怎么读？是什么意思？"></a>Q2: requite 怎么读？是什么意思？</h3><p><strong>A:</strong> </p><ul><li><strong>发音</strong>：/rɪˈkwaɪt/，中文近似音：<strong>瑞-快特</strong></li><li><strong>含义</strong>：报答、回报、归还</li><li><strong>在代码中</strong>：表示将连接归还到池中</li></ul><h3 id="Q3-listener、waiters、sharedList-分别是什么？"><a href="#Q3-listener、waiters、sharedList-分别是什么？" class="headerlink" title="Q3: listener、waiters、sharedList 分别是什么？"></a>Q3: listener、waiters、sharedList 分别是什么？</h3><p><strong>A:</strong></p><ul><li><strong>sharedList</strong>：存储所有连接的全局共享列表（<code>CopyOnWriteArrayList</code>）</li><li><strong>waiters</strong>：统计当前等待连接的线程数（<code>AtomicInteger</code>）</li><li><strong>listener</strong>：回调接口，当需要创建新连接时通知 <code>HikariPool</code></li></ul><h3 id="Q4-handoffQueue-是干什么的？"><a href="#Q4-handoffQueue-是干什么的？" class="headerlink" title="Q4: handoffQueue 是干什么的？"></a>Q4: handoffQueue 是干什么的？</h3><p><strong>A:</strong> </p><ul><li><strong>作用</strong>：直接交付连接给等待线程</li><li><strong>类型</strong>：<code>SynchronousQueue</code>（无缓冲队列）</li><li><strong>优势</strong>：避免等待线程被唤醒后还要扫描共享列表</li></ul><h3 id="Q5-为什么用-CopyOnWriteArrayList？"><a href="#Q5-为什么用-CopyOnWriteArrayList？" class="headerlink" title="Q5: 为什么用 CopyOnWriteArrayList？"></a>Q5: 为什么用 CopyOnWriteArrayList？</h3><p><strong>A:</strong></p><ul><li><strong>读多写少</strong>：连接池中遍历查找是高频操作</li><li><strong>读操作无锁</strong>：多线程并发读取性能好</li><li><strong>线程安全</strong>：无需额外同步</li><li><strong>避免异常</strong>：遍历时不会因并发修改而抛异常</li></ul><h3 id="Q6-为什么不使用读写锁或-Vector？"><a href="#Q6-为什么不使用读写锁或-Vector？" class="headerlink" title="Q6: 为什么不使用读写锁或 Vector？"></a>Q6: 为什么不使用读写锁或 Vector？</h3><p><strong>A:</strong></p><table><thead><tr><th>方案</th><th>问题</th></tr></thead><tbody><tr><td><strong>Vector</strong></td><td>所有操作都加锁，性能差</td></tr><tr><td><strong>ArrayList + synchronized</strong></td><td>读操作被写操作阻塞</td></tr><tr><td><strong>ReadWriteLock</strong></td><td>仍有锁开销，写操作会阻塞读操作</td></tr><tr><td><strong>CopyOnWriteArrayList</strong></td><td>✅ 读操作完全无锁，性能最优</td></tr></tbody></table><hr><h2 id="设计决策分析"><a href="#设计决策分析" class="headerlink" title="设计决策分析"></a>设计决策分析</h2><h3 id="CopyOnWriteArrayList-vs-ReadWriteLock"><a href="#CopyOnWriteArrayList-vs-ReadWriteLock" class="headerlink" title="CopyOnWriteArrayList vs ReadWriteLock"></a>CopyOnWriteArrayList vs ReadWriteLock</h3><h4 id="CopyOnWriteArrayList-的优势"><a href="#CopyOnWriteArrayList-的优势" class="headerlink" title="CopyOnWriteArrayList 的优势"></a>CopyOnWriteArrayList 的优势</h4><ol><li>✅ <strong>读操作完全无锁</strong>，性能最优</li><li>✅ <strong>读操作不会被写操作阻塞</strong></li><li>✅ <strong>实现简单</strong>，无死锁风险</li><li>✅ <strong>适合读多写少的场景</strong></li></ol><h4 id="ReadWriteLock-的优势"><a href="#ReadWriteLock-的优势" class="headerlink" title="ReadWriteLock 的优势"></a>ReadWriteLock 的优势</h4><ol><li>✅ <strong>数据实时性好</strong>（不是快照）</li><li>✅ <strong>写操作性能更好</strong>（不复制数组）</li><li>✅ <strong>内存占用更少</strong></li><li>✅ <strong>适合读写均衡或写多读少的场景</strong></li></ol><h4 id="选择建议"><a href="#选择建议" class="headerlink" title="选择建议"></a>选择建议</h4><ul><li><strong>读多写少</strong> → CopyOnWriteArrayList（如连接池）✓</li><li><strong>读写均衡</strong> → ReadWriteLock</li><li><strong>写多读少</strong> → ReadWriteLock</li><li><strong>需要实时数据</strong> → ReadWriteLock</li><li><strong>需要最高读性能</strong> → CopyOnWriteArrayList</li></ul><h3 id="为什么选择三层查找机制？"><a href="#为什么选择三层查找机制？" class="headerlink" title="为什么选择三层查找机制？"></a>为什么选择三层查找机制？</h3><h4 id="设计优势"><a href="#设计优势" class="headerlink" title="设计优势"></a>设计优势</h4><ol><li><strong>性能优化</strong>：优先使用线程本地列表，减少锁竞争</li><li><strong>负载均衡</strong>：共享列表允许线程间共享连接</li><li><strong>及时响应</strong>：等待队列直接交付，减少唤醒延迟</li><li><strong>无锁设计</strong>：大量使用 CAS，避免传统锁的开销</li><li><strong>自适应</strong>：根据等待线程数动态创建连接</li></ol><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>HikariCP 的连接池设计体现了以下核心思想：</p><ol><li><strong>无锁优先</strong>：尽可能使用无锁设计（CAS、ThreadLocal）</li><li><strong>读多写少优化</strong>：针对连接池场景优化（CopyOnWriteArrayList）</li><li><strong>三层查找</strong>：线程本地 → 共享列表 → 等待队列</li><li><strong>直接交付</strong>：使用 handoffQueue 减少延迟</li><li><strong>健康检查</strong>：aliveBypassWindowMs 平衡性能和可靠性</li></ol><p>这些设计使得 HikariCP 在保证线程安全的同时，实现了极高的并发性能。</p><hr><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li>HikariCP 源码：<code>src/main/java/com/zaxxer/hikari/</code></li><li>关键类：<ul><li><code>HikariPool.java</code>：连接池主类</li><li><code>ConcurrentBag.java</code>：连接容器</li><li><code>PoolEntry.java</code>：连接条目</li><li><code>ProxyConnection.java</code>：代理连接</li></ul></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>rocketmq探秘</title>
      <link href="/posts/27340.html"/>
      <url>/posts/27340.html</url>
      
        <content type="html"><![CDATA[<h3 id="rocketmq-服务端如何处理发送消息请求"><a href="#rocketmq-服务端如何处理发送消息请求" class="headerlink" title="rocketmq 服务端如何处理发送消息请求"></a>rocketmq 服务端如何处理发送消息请求</h3><h3 id="rocketmq-服务端如何处理发消费者拉取请求"><a href="#rocketmq-服务端如何处理发消费者拉取请求" class="headerlink" title="rocketmq 服务端如何处理发消费者拉取请求"></a>rocketmq 服务端如何处理发消费者拉取请求</h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 分布式中间件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DirectedByteBuffer的使用</title>
      <link href="/posts/70000.html"/>
      <url>/posts/70000.html</url>
      
        <content type="html"><![CDATA[<p>这是第一篇博客</p><ul><li>孙悟空222</li><li>猪八戒</li><li>沙师弟</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java NIO Buffer 使用与实现原理</title>
      <link href="/posts/128001.html"/>
      <url>/posts/128001.html</url>
      
        <content type="html"><![CDATA[<p>这是第一篇博客</p><h1 id="Java-NIO-Buffer-使用与实现原理"><a href="#Java-NIO-Buffer-使用与实现原理" class="headerlink" title="Java NIO Buffer 使用与实现原理"></a>Java NIO Buffer 使用与实现原理</h1><h2 id="1-Buffer-概述"><a href="#1-Buffer-概述" class="headerlink" title="1. Buffer 概述"></a>1. Buffer 概述</h2><h3 id="1-1-什么是-Buffer"><a href="#1-1-什么是-Buffer" class="headerlink" title="1.1 什么是 Buffer"></a>1.1 什么是 Buffer</h3><p>Buffer（缓冲区）是 Java NIO 中用于与通道（Channel）进行数据交互的对象。它是一个线性的、有限的数据容器，本质上是一个数组，但提供了更丰富的操作接口。</p><h3 id="1-2-Buffer-的核心特性"><a href="#1-2-Buffer-的核心特性" class="headerlink" title="1.2 Buffer 的核心特性"></a>1.2 Buffer 的核心特性</h3><ul><li><strong>容量（Capacity）</strong>：Buffer 的最大数据容量，创建后不可改变</li><li><strong>位置（Position）</strong>：下一个要读取或写入的索引位置</li><li><strong>限制（Limit）</strong>：第一个不应该读取或写入的索引位置</li><li><strong>标记（Mark）</strong>：一个备忘位置，可以通过 <code>reset()</code> 恢复到该位置</li></ul><h3 id="1-3-Buffer-的类型"><a href="#1-3-Buffer-的类型" class="headerlink" title="1.3 Buffer 的类型"></a>1.3 Buffer 的类型</h3><p>Java NIO 提供了以下类型的 Buffer：</p><ul><li><code>ByteBuffer</code></li><li><code>CharBuffer</code></li><li><code>ShortBuffer</code></li><li><code>IntBuffer</code></li><li><code>LongBuffer</code></li><li><code>FloatBuffer</code></li><li><code>DoubleBuffer</code></li></ul><p>其中 <code>ByteBuffer</code> 是最常用的，其他类型都是基于 <code>ByteBuffer</code> 的视图。</p><h2 id="2-Buffer-的基本使用"><a href="#2-Buffer-的基本使用" class="headerlink" title="2. Buffer 的基本使用"></a>2. Buffer 的基本使用</h2><h3 id="2-1-创建-Buffer"><a href="#2-1-创建-Buffer" class="headerlink" title="2.1 创建 Buffer"></a>2.1 创建 Buffer</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 方式1：分配指定容量的 Buffer（堆内存）</span>ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式2：分配直接内存 Buffer（堆外内存）</span>ByteBuffer directBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式3：包装现有数组</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ByteBuffer wrappedBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-写入数据到-Buffer"><a href="#2-2-写入数据到-Buffer" class="headerlink" title="2.2 写入数据到 Buffer"></a>2.2 写入数据到 Buffer</h3><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式1：使用 put() 方法</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'H'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'o'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式2：批量写入</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式3：从 Channel 读取数据到 Buffer</span>channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-3-从-Buffer-读取数据"><a href="#2-3-从-Buffer-读取数据" class="headerlink" title="2.3 从 Buffer 读取数据"></a>2.3 从 Buffer 读取数据</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 切换为读模式</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式1：逐个读取</span><span class="token keyword">while</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 方式2：批量读取</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式3：写入到 Channel</span>channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-4-Buffer-的状态转换"><a href="#2-4-Buffer-的状态转换" class="headerlink" title="2.4 Buffer 的状态转换"></a>2.4 Buffer 的状态转换</h3><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 初始状态：position=0, limit=capacity</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"初始: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 写入数据后：position 移动到写入位置</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写入后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// flip()：切换为读模式，limit=position, position=0</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"flip后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 读取数据后：position 移动到读取位置</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读取后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// rewind()：重新读取，position=0, limit 不变</span>buffer<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rewind后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// clear()：清空 Buffer，position=0, limit=capacity（但数据未清除）</span>buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"clear后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-Buffer-核心方法详解"><a href="#3-Buffer-核心方法详解" class="headerlink" title="3. Buffer 核心方法详解"></a>3. Buffer 核心方法详解</h2><h3 id="3-1-flip-切换为读模式"><a href="#3-1-flip-切换为读模式" class="headerlink" title="3.1 flip() - 切换为读模式"></a>3.1 flip() - 切换为读模式</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    limit <span class="token operator">=</span> position<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 将 limit 设置为当前 position</span>    position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 将 position 重置为 0</span>    mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 清除标记</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>使用场景</strong>：写入数据后，准备读取数据时调用。</p><h3 id="3-2-clear-清空-Buffer"><a href="#3-2-clear-清空-Buffer" class="headerlink" title="3.2 clear() - 清空 Buffer"></a>3.2 clear() - 清空 Buffer</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// position 重置为 0</span>    limit <span class="token operator">=</span> capacity<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// limit 设置为 capacity</span>    mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 清除标记</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意</strong>：<code>clear()</code> 不会清除 Buffer 中的数据，只是重置了位置指针，数据仍然存在。</p><h3 id="3-3-rewind-重新读取"><a href="#3-3-rewind-重新读取" class="headerlink" title="3.3 rewind() - 重新读取"></a>3.3 rewind() - 重新读取</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// position 重置为 0</span>    mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 清除标记</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>使用场景</strong>：需要重新读取 Buffer 中的数据，但 limit 保持不变。</p><h3 id="3-4-compact-压缩-Buffer"><a href="#3-4-compact-压缩-Buffer" class="headerlink" title="3.4 compact() - 压缩 Buffer"></a>3.4 compact() - 压缩 Buffer</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> ByteBuffer <span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>hb<span class="token punctuation">,</span> <span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hb<span class="token punctuation">,</span> <span class="token function">ix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">position</span><span class="token punctuation">(</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">limit</span><span class="token punctuation">(</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">discardMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>作用</strong>：将未读取的数据移动到 Buffer 的开头，为后续写入腾出空间。</p><p><strong>使用场景</strong>：部分读取数据后，需要继续写入新数据。</p><h3 id="3-5-mark-和-reset-标记和重置"><a href="#3-5-mark-和-reset-标记和重置" class="headerlink" title="3.5 mark() 和 reset() - 标记和重置"></a>3.5 mark() 和 reset() - 标记和重置</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    mark <span class="token operator">=</span> position<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 记录当前 position</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> m <span class="token operator">=</span> mark<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidMarkException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    position <span class="token operator">=</span> m<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 恢复到标记位置</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-Buffer-实现原理深度剖析"><a href="#4-Buffer-实现原理深度剖析" class="headerlink" title="4. Buffer 实现原理深度剖析"></a>4. Buffer 实现原理深度剖析</h2><h3 id="4-1-Buffer-的类层次结构"><a href="#4-1-Buffer-的类层次结构" class="headerlink" title="4.1 Buffer 的类层次结构"></a>4.1 Buffer 的类层次结构</h3><pre><code>Buffer (抽象类)  ├── ByteBuffer (抽象类)  │   ├── HeapByteBuffer (堆内存实现)  │   └── DirectByteBuffer (直接内存实现)  ├── CharBuffer  ├── ShortBuffer  ├── IntBuffer  ├── LongBuffer  ├── FloatBuffer  └── DoubleBuffer</code></pre><h3 id="4-2-Buffer-核心字段"><a href="#4-2-Buffer-核心字段" class="headerlink" title="4.2 Buffer 核心字段"></a>4.2 Buffer 核心字段</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Buffer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 标记位置</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 当前位置</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 限制位置</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> limit<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 容量</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 地址（用于直接内存）</span>    <span class="token keyword">long</span> address<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-3-HeapByteBuffer-实现"><a href="#4-3-HeapByteBuffer-实现" class="headerlink" title="4.3 HeapByteBuffer 实现"></a>4.3 HeapByteBuffer 实现</h3><h4 id="4-3-1-内部结构"><a href="#4-3-1-内部结构" class="headerlink" title="4.3.1 内部结构"></a>4.3.1 内部结构</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">HeapByteBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">ByteBuffer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 底层数组</span>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hb<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 数组偏移量</span>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> offset<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 是否为只读</span>    <span class="token keyword">boolean</span> isReadOnly<span class="token punctuation">;</span>    <span class="token function">HeapByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>cap<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// hb 在父类中初始化</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-3-2-数据访问实现"><a href="#4-3-2-数据访问实现" class="headerlink" title="4.3.2 数据访问实现"></a>4.3.2 数据访问实现</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 获取数据</span><span class="token keyword">public</span> <span class="token keyword">byte</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">nextGetIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">byte</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">checkIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 写入数据</span><span class="token keyword">public</span> ByteBuffer <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">byte</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">nextPutIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> ByteBuffer <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">byte</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">checkIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 计算实际索引</span><span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">ix</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> i <span class="token operator">+</span> offset<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li><code>HeapByteBuffer</code> 使用 Java 堆内存中的 <code>byte[]</code> 数组</li><li>所有操作都是对数组的直接访问</li><li>受 GC 管理，内存分配和回收由 JVM 控制</li></ul><h3 id="4-4-DirectByteBuffer-实现"><a href="#4-4-DirectByteBuffer-实现" class="headerlink" title="4.4 DirectByteBuffer 实现"></a>4.4 DirectByteBuffer 实现</h3><h4 id="4-4-1-内部结构"><a href="#4-4-1-内部结构" class="headerlink" title="4.4.1 内部结构"></a>4.4.1 内部结构</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DirectByteBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">MappedByteBuffer</span> <span class="token keyword">implements</span> <span class="token class-name">DirectBuffer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 直接内存地址</span>    <span class="token keyword">protected</span> <span class="token keyword">long</span> address<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 内存分配器</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Cleaner cleaner<span class="token punctuation">;</span>    <span class="token function">DirectByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cap<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> pa <span class="token operator">=</span> VM<span class="token punctuation">.</span><span class="token function">isDirectMemoryPageAligned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> ps <span class="token operator">=</span> Bits<span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> size <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>cap <span class="token operator">+</span> <span class="token punctuation">(</span>pa <span class="token operator">?</span> ps <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Bits<span class="token punctuation">.</span><span class="token function">reserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 分配直接内存</span>            base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Bits<span class="token punctuation">.</span><span class="token function">unreserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> x<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>base <span class="token operator">%</span> ps <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            address <span class="token operator">=</span> base <span class="token operator">+</span> ps <span class="token operator">-</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            address <span class="token operator">=</span> base<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 创建清理器，用于释放直接内存</span>        cleaner <span class="token operator">=</span> Cleaner<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Deallocator</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        att <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-4-2-内存分配机制"><a href="#4-4-2-内存分配机制" class="headerlink" title="4.4.2 内存分配机制"></a>4.4.2 内存分配机制</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 使用 Unsafe 分配直接内存</span><span class="token keyword">long</span> base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置内存内容</span>unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 计算对齐后的地址</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>base <span class="token operator">%</span> ps <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    address <span class="token operator">=</span> base <span class="token operator">+</span> ps <span class="token operator">-</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    address <span class="token operator">=</span> base<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li><code>DirectByteBuffer</code> 使用堆外内存（直接内存）</li><li>通过 <code>Unsafe.allocateMemory()</code> 分配</li><li>不受 GC 直接管理，需要手动释放</li><li>使用 <code>Cleaner</code> 机制在对象被 GC 时自动释放内存</li></ul><h4 id="4-4-3-内存释放机制"><a href="#4-4-3-内存释放机制" class="headerlink" title="4.4.3 内存释放机制"></a>4.4.3 内存释放机制</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Deallocator</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Unsafe unsafe <span class="token operator">=</span> Unsafe<span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> address<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Deallocator</span><span class="token punctuation">(</span><span class="token keyword">long</span> address<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">assert</span> <span class="token punctuation">(</span>address <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>address <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 释放直接内存</span>        unsafe<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>        address <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        Bits<span class="token punctuation">.</span><span class="token function">unreserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>内存释放流程</strong>：</p><ol><li><code>DirectByteBuffer</code> 对象被 GC 回收</li><li><code>Cleaner</code> 检测到对象被回收</li><li>调用 <code>Deallocator.run()</code> 释放直接内存</li><li>调用 <code>Unsafe.freeMemory()</code> 释放内存</li></ol><h3 id="4-5-Buffer-的视图机制"><a href="#4-5-Buffer-的视图机制" class="headerlink" title="4.5 Buffer 的视图机制"></a>4.5 Buffer 的视图机制</h3><h4 id="4-5-1-创建视图"><a href="#4-5-1-创建视图" class="headerlink" title="4.5.1 创建视图"></a>4.5.1 创建视图</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 创建只读视图</span><span class="token keyword">public</span> ByteBuffer <span class="token function">asReadOnlyBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapByteBufferR</span><span class="token punctuation">(</span>hb<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">markValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 创建其他类型的视图</span><span class="token keyword">public</span> CharBuffer <span class="token function">asCharBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> off <span class="token operator">=</span> offset <span class="token operator">+</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>bigEndian            <span class="token operator">?</span> <span class="token punctuation">(</span>CharBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteBufferAsCharBufferB</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token operator">:</span> <span class="token punctuation">(</span>CharBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteBufferAsCharBufferL</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-5-2-视图共享机制"><a href="#4-5-2-视图共享机制" class="headerlink" title="4.5.2 视图共享机制"></a>4.5.2 视图共享机制</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 视图 Buffer 共享底层数组</span><span class="token keyword">class</span> <span class="token class-name">HeapByteBufferR</span> <span class="token keyword">extends</span> <span class="token class-name">HeapByteBuffer</span> <span class="token punctuation">{</span>    <span class="token function">HeapByteBufferR</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> mark<span class="token punctuation">,</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">,</span> <span class="token keyword">int</span> cap<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> mark<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isReadOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 标记为只读</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 所有修改操作都抛出异常</span>    <span class="token keyword">public</span> ByteBuffer <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">byte</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReadOnlyBufferException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li>视图 Buffer 共享底层数据数组</li><li>修改一个 Buffer 会影响其他视图</li><li>但每个视图有独立的 position、limit、mark</li></ul><h3 id="4-6-Buffer-的字节序（ByteOrder）"><a href="#4-6-Buffer-的字节序（ByteOrder）" class="headerlink" title="4.6 Buffer 的字节序（ByteOrder）"></a>4.6 Buffer 的字节序（ByteOrder）</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ByteBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">Buffer</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token operator">&lt;</span>ByteBuffer<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 字节序：大端（BIG_ENDIAN）或小端（LITTLE_ENDIAN）</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> bigEndian<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 默认使用大端序</span>    <span class="token function">ByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> mark<span class="token punctuation">,</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">,</span> <span class="token keyword">int</span> cap<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hb<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>mark<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>hb <span class="token operator">=</span> hb<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>bigEndian <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 默认大端序</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 设置字节序</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ByteBuffer <span class="token function">order</span><span class="token punctuation">(</span>ByteOrder bo<span class="token punctuation">)</span> <span class="token punctuation">{</span>        bigEndian <span class="token operator">=</span> <span class="token punctuation">(</span>bo <span class="token operator">==</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span><span class="token punctuation">;</span>        nativeByteOrder <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>字节序影响</strong>：</p><ul><li>多字节数据类型（int、long 等）的存储顺序</li><li>大端序：高位字节在前（网络字节序）</li><li>小端序：低位字节在前（x86 架构默认）</li></ul><h2 id="5-Buffer-使用最佳实践"><a href="#5-Buffer-使用最佳实践" class="headerlink" title="5. Buffer 使用最佳实践"></a>5. Buffer 使用最佳实践</h2><h3 id="5-1-堆内存-vs-直接内存"><a href="#5-1-堆内存-vs-直接内存" class="headerlink" title="5.1 堆内存 vs 直接内存"></a>5.1 堆内存 vs 直接内存</h3><table><thead><tr><th>特性</th><th>HeapByteBuffer</th><th>DirectByteBuffer</th></tr></thead><tbody><tr><td>内存位置</td><td>堆内存</td><td>堆外内存</td></tr><tr><td>分配速度</td><td>快</td><td>慢</td></tr><tr><td>访问速度</td><td>相对慢</td><td>相对快</td></tr><tr><td>GC 管理</td><td>是</td><td>否（通过 Cleaner）</td></tr><tr><td>适用场景</td><td>小数据量、频繁创建</td><td>大数据量、长期存在</td></tr></tbody></table><h3 id="5-2-使用建议"><a href="#5-2-使用建议" class="headerlink" title="5.2 使用建议"></a>5.2 使用建议</h3><ol><li><p><strong>选择合适的 Buffer 类型</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 小数据量、临时使用</span>ByteBuffer heapBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 大数据量、需要与操作系统交互</span>ByteBuffer directBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>正确使用 flip() 和 clear()</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 写入数据后准备读取</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 读取完成后准备重新写入</span>buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 部分读取后继续写入</span>buffer<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>避免频繁创建 Buffer</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 不好的做法</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 使用 buffer</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 好的做法：复用 Buffer</span>ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 使用 buffer</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>注意直接内存的释放</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// DirectByteBuffer 会在 GC 时自动释放</span><span class="token comment" spellcheck="true">// 但可以通过以下方式显式释放（不推荐）</span>DirectBuffer db <span class="token operator">=</span> <span class="token punctuation">(</span>DirectBuffer<span class="token punctuation">)</span> directBuffer<span class="token punctuation">;</span>Cleaner cleaner <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">cleaner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>cleaner <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    cleaner<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="5-3-常见错误和陷阱"><a href="#5-3-常见错误和陷阱" class="headerlink" title="5.3 常见错误和陷阱"></a>5.3 常见错误和陷阱</h3><ol><li><p><strong>忘记调用 flip()</strong></p><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 错误：没有调用 flip()，position 在末尾，读取不到数据</span><span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 会抛出 BufferUnderflowException</span><span class="token comment" spellcheck="true">// 正确做法</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 正常读取</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>clear() 不会清除数据</strong></p><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 数据仍然存在，只是 position 和 limit 被重置</span><span class="token comment" spellcheck="true">// 如果需要清除数据，需要手动覆盖</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>视图 Buffer 共享数据</strong></p><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ByteBuffer view <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">duplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>view<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'h'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 修改视图</span><span class="token comment" spellcheck="true">// 原 buffer 的数据也被修改了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="6-Buffer-性能优化"><a href="#6-Buffer-性能优化" class="headerlink" title="6. Buffer 性能优化"></a>6. Buffer 性能优化</h2><h3 id="6-1-批量操作"><a href="#6-1-批量操作" class="headerlink" title="6.1 批量操作"></a>6.1 批量操作</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 单个操作（慢）</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 批量操作（快）</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-2-使用-slice-避免复制"><a href="#6-2-使用-slice-避免复制" class="headerlink" title="6.2 使用 slice() 避免复制"></a>6.2 使用 slice() 避免复制</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 不需要复制数据，创建子 Buffer</span>ByteBuffer subBuffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>subBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>subBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 操作 subBuffer 不会影响原 buffer 的 position 和 limit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-3-直接内存的合理使用"><a href="#6-3-直接内存的合理使用" class="headerlink" title="6.3 直接内存的合理使用"></a>6.3 直接内存的合理使用</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 对于需要与操作系统交互的场景，使用直接内存</span><span class="token comment" spellcheck="true">// 例如：文件 I/O、网络 I/O</span>FileChannel channel <span class="token operator">=</span> FileChannel<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> StandardOpenOption<span class="token punctuation">.</span>READ<span class="token punctuation">)</span><span class="token punctuation">;</span>ByteBuffer directBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>directBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><h3 id="7-1-核心要点"><a href="#7-1-核心要点" class="headerlink" title="7.1 核心要点"></a>7.1 核心要点</h3><ol><li><strong>Buffer 的四个核心属性</strong>：capacity、position、limit、mark</li><li><strong>状态转换</strong>：通过 <code>flip()</code>、<code>clear()</code>、<code>rewind()</code>、<code>compact()</code> 等方法切换状态</li><li><strong>两种实现</strong>：<code>HeapByteBuffer</code>（堆内存）和 <code>DirectByteBuffer</code>（直接内存）</li><li><strong>视图机制</strong>：可以创建只读视图、类型视图等，共享底层数据</li></ol><h3 id="7-2-实现原理要点"><a href="#7-2-实现原理要点" class="headerlink" title="7.2 实现原理要点"></a>7.2 实现原理要点</h3><ol><li><strong>HeapByteBuffer</strong>：基于 Java 数组，受 GC 管理，访问速度相对较慢</li><li><strong>DirectByteBuffer</strong>：使用堆外内存，通过 <code>Unsafe</code> 分配，使用 <code>Cleaner</code> 自动释放</li><li><strong>字节序</strong>：影响多字节数据类型的存储和读取顺序</li><li><strong>视图共享</strong>：多个视图 Buffer 共享底层数组，但各自维护独立的 position、limit、mark</li></ol><h3 id="7-3-使用建议"><a href="#7-3-使用建议" class="headerlink" title="7.3 使用建议"></a>7.3 使用建议</h3><ul><li>根据场景选择合适的 Buffer 类型</li><li>正确使用状态转换方法</li><li>避免频繁创建 Buffer，尽量复用</li><li>注意直接内存的使用和释放</li><li>使用批量操作提高性能</li></ul><hr><p><strong>参考资源</strong>：</p><ul><li><a href="https://docs.oracle.com/javase/8/docs/api/java/nio/Buffer.html">Java NIO Buffer 官方文档</a></li><li><a href="https://jenkov.com/tutorials/java-nio/buffers.html">Java NIO 教程</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>&#39;vmvare三种网络模式&#39;</title>
      <link href="/posts/54158.html"/>
      <url>/posts/54158.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>&#39;第一篇博客&#39;</title>
      <link href="/posts/13058.html"/>
      <url>/posts/13058.html</url>
      
        <content type="html"><![CDATA[<p>这是第一篇博客</p><ul><li>孙悟空</li><li>猪八戒</li><li>沙师弟</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> -test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>&#39;序言&#39;</title>
      <link href="/posts/61229.html"/>
      <url>/posts/61229.html</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>本博客搭建详细教程</title>
      <link href="/posts/6.html"/>
      <url>/posts/6.html</url>
      
        <content type="html"><![CDATA[<h2 id="本博客详细教程地址："><a href="#本博客详细教程地址：" class="headerlink" title="本博客详细教程地址："></a>本博客详细教程地址：</h2><p>系列教程：</p><ul><li><a href="http://sitoi.cn/posts/6666.html">基于 Hexo GitHub 从零开始搭建个人博客（一）：环境准备篇</a></li><li><a href="https://sitoi.cn/posts/27801.html">基于 Hexo GitHub 从零开始搭建个人博客（二）：搭建基础篇</a></li><li><a href="https://sitoi.cn/posts/63466.html">基于 Hexo GitHub 从零开始搭建个人博客（三）：Matery 主题（DIY 版）详细配置教程，附博客源码</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Hexo </tag>
            
            <tag> GitHub </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
