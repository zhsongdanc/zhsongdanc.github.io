<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>下一个</title>
      <link href="/posts/43494.html"/>
      <url>/posts/43494.html</url>
      
        <content type="html"><![CDATA[<p>105</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>HikariCP 连接池详解</title>
      <link href="/posts/101.html"/>
      <url>/posts/101.html</url>
      
        <content type="html"><![CDATA[<h1 id="HikariCP-连接池详解"><a href="#HikariCP-连接池详解" class="headerlink" title="HikariCP 连接池详解"></a>HikariCP 连接池详解</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol><li><a href="#核心概念">核心概念</a></li><li><a href="#连接获取流程">连接获取流程</a></li><li><a href="#连接归还流程">连接归还流程</a></li><li><a href="#concurrentbag-三层查找机制">ConcurrentBag 三层查找机制</a></li><li><a href="#关键组件详解">关键组件详解</a></li><li><a href="#常见问题解答">常见问题解答</a></li><li><a href="#设计决策分析">设计决策分析</a></li></ol><hr><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="1-基本组件"><a href="#1-基本组件" class="headerlink" title="1. 基本组件"></a>1. 基本组件</h3><h4 id="Connection（真实连接）"><a href="#Connection（真实连接）" class="headerlink" title="Connection（真实连接）"></a>Connection（真实连接）</h4><ul><li>数据库驱动提供的真实 JDBC 连接</li><li>例如 MySQL 的 <code>com.mysql.cj.jdbc.ConnectionImpl</code></li><li>直接与数据库通信</li></ul><h4 id="PoolEntry（连接条目）"><a href="#PoolEntry（连接条目）" class="headerlink" title="PoolEntry（连接条目）"></a>PoolEntry（连接条目）</h4><ul><li>连接池内部用来管理连接的包装类</li><li>每个 <code>PoolEntry</code> 唯一对应一个真实的 <code>Connection</code></li><li>包含连接的状态、时间戳等信息</li></ul><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PoolEntry</span> <span class="token keyword">implements</span> <span class="token class-name">IConcurrentBagEntry</span> <span class="token punctuation">{</span>    Connection connection<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 真实连接</span>    <span class="token keyword">long</span> lastAccessed<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 最后访问时间</span>    <span class="token keyword">long</span> lastBorrowed<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 最后借出时间</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 状态（空闲/使用中/已移除等）</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> evict<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 是否被标记驱逐</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ProxyConnection（代理连接）"><a href="#ProxyConnection（代理连接）" class="headerlink" title="ProxyConnection（代理连接）"></a>ProxyConnection（代理连接）</h4><ul><li>应用层拿到的连接对象</li><li>内部持有 <code>PoolEntry</code> 和真实 <code>Connection</code></li><li>拦截 <code>close()</code> 等方法，将连接归还池中而不是真正关闭</li></ul><h4 id="ConcurrentBag（连接袋）"><a href="#ConcurrentBag（连接袋）" class="headerlink" title="ConcurrentBag（连接袋）"></a>ConcurrentBag（连接袋）</h4><ul><li>存放 <code>PoolEntry</code> 的容器</li><li>提供 <code>borrow()</code> 和 <code>requite()</code> 方法</li><li>使用线程本地缓存和共享列表，减少锁竞争</li></ul><h4 id="bagEntry"><a href="#bagEntry" class="headerlink" title="bagEntry"></a>bagEntry</h4><ul><li><code>bagEntry</code> 就是 <code>PoolEntry</code></li><li>在 <code>ConcurrentBag</code> 的方法里，参数名用 <code>bagEntry</code> 表示”袋子里的条目”</li></ul><h3 id="2-关系图"><a href="#2-关系图" class="headerlink" title="2. 关系图"></a>2. 关系图</h3><pre><code>应用代码   ↓ 调用 getConnection()HikariPool   ↓ 从 ConcurrentBag 借出PoolEntry (bagEntry)   ↓ 包装成ProxyConnection   ↓ 返回给应用应用拿到 ProxyConnection，但实际使用的是 PoolEntry 里的真实 Connection</code></pre><hr><h2 id="连接获取流程"><a href="#连接获取流程" class="headerlink" title="连接获取流程"></a>连接获取流程</h2><h3 id="1-入口方法"><a href="#1-入口方法" class="headerlink" title="1. 入口方法"></a>1. 入口方法</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Connection <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> hardTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>    suspendResumeLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> timeout <span class="token operator">=</span> hardTimeout<span class="token punctuation">;</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 从 ConcurrentBag 借出 PoolEntry</span>            PoolEntry poolEntry <span class="token operator">=</span> connectionBag<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>poolEntry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 超时</span>            <span class="token punctuation">}</span>            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 健康检查</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span><span class="token function">isMarkedEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>                 <span class="token punctuation">(</span><span class="token function">elapsedMillis</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>lastAccessed<span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">&gt;</span> aliveBypassWindowMs                  <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isConnectionAlive</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>connection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 连接不可用，关闭并重试</span>                <span class="token function">closeConnection</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                timeout <span class="token operator">=</span> hardTimeout <span class="token operator">-</span> <span class="token function">elapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 连接可用，创建代理连接返回</span>                metricsTracker<span class="token punctuation">.</span><span class="token function">recordBorrowStats</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> poolEntry<span class="token punctuation">.</span><span class="token function">createProxyConnection</span><span class="token punctuation">(</span>                    leakTaskFactory<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>timeout <span class="token operator">&gt;</span> 0L<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 超时，抛出异常</span>        metricsTracker<span class="token punctuation">.</span><span class="token function">recordBorrowTimeoutStats</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> <span class="token function">createTimeoutException</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        suspendResumeLock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-关键步骤"><a href="#2-关键步骤" class="headerlink" title="2. 关键步骤"></a>2. 关键步骤</h3><ol><li><strong>获取 suspendResumeLock</strong>：确保池未被挂起</li><li><strong>从 ConcurrentBag 借出</strong>：三层查找机制（见下文）</li><li><strong>健康检查</strong>：<ul><li>检查是否被标记驱逐</li><li>检查连接是否存活（超过 <code>aliveBypassWindowMs</code> 需要检测）</li></ul></li><li><strong>创建代理连接</strong>：包装成 <code>ProxyConnection</code> 并启动泄漏检测</li><li><strong>返回给应用</strong>：应用获得代理连接</li></ol><hr><h2 id="连接归还流程"><a href="#连接归还流程" class="headerlink" title="连接归还流程"></a>连接归还流程</h2><h3 id="1-应用调用-close"><a href="#1-应用调用-close" class="headerlink" title="1. 应用调用 close()"></a>1. 应用调用 close()</h3><pre class="line-numbers language-java"><code class="language-java">connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 应用代码</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-ProxyConnection-拦截-close"><a href="#2-ProxyConnection-拦截-close" class="headerlink" title="2. ProxyConnection 拦截 close()"></a>2. ProxyConnection 拦截 close()</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1. 关闭所有 Statement</span>    <span class="token function">closeStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate <span class="token operator">!=</span> ClosedConnection<span class="token punctuation">.</span>CLOSED_CONNECTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 2. 取消泄漏检测任务</span>        leakTask<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 3. 清理连接状态</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isCommitStateDirty <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isAutoCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>                delegate<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>dirtyBits <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                poolEntry<span class="token punctuation">.</span><span class="token function">resetConnectionState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dirtyBits<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            delegate<span class="token punctuation">.</span><span class="token function">clearWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poolEntry<span class="token punctuation">.</span><span class="token function">isMarkedEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token function">checkException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 4. 归还连接</span>            delegate <span class="token operator">=</span> ClosedConnection<span class="token punctuation">.</span>CLOSED_CONNECTION<span class="token punctuation">;</span>            poolEntry<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>lastAccess<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-调用链"><a href="#3-调用链" class="headerlink" title="3. 调用链"></a>3. 调用链</h3><pre><code>ProxyConnection.close()    ↓ 调用 poolEntry.recycle(lastAccess)PoolEntry.recycle()    ↓ 调用 hikariPool.recycle(this)HikariPool.recycle()    ↓ 调用 connectionBag.requite(poolEntry)ConcurrentBag.requite()    ↓ 执行 threadLocalList.add(bagEntry) 或放入 handoffQueue连接被归还到池中 ✓</code></pre><h3 id="4-requite-方法详解"><a href="#4-requite-方法详解" class="headerlink" title="4. requite() 方法详解"></a>4. requite() 方法详解</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requite</span><span class="token punctuation">(</span><span class="token keyword">final</span> T bagEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1. 设置状态为空闲</span>    bagEntry<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 2. 如果有等待线程，优先放入 handoffQueue 直接交付</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> waiters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> STATE_NOT_IN_USE <span class="token operator">||</span>             handoffQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>bagEntry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 重试逻辑...</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 3. 否则放入线程本地列表（最多50个）</span>    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> threadLocalList <span class="token operator">=</span> threadList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadLocalList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        threadLocalList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>weakThreadLocals <span class="token operator">?</span>             <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>bagEntry<span class="token punctuation">)</span> <span class="token operator">:</span> bagEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="ConcurrentBag-三层查找机制"><a href="#ConcurrentBag-三层查找机制" class="headerlink" title="ConcurrentBag 三层查找机制"></a>ConcurrentBag 三层查找机制</h2><h3 id="第一层：线程本地列表（threadList）"><a href="#第一层：线程本地列表（threadList）" class="headerlink" title="第一层：线程本地列表（threadList）"></a>第一层：线程本地列表（threadList）</h3><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Try the thread-local list first</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> list <span class="token operator">=</span> threadList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> Object entry <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> T bagEntry <span class="token operator">=</span> weakThreadLocals <span class="token operator">?</span>         <span class="token punctuation">(</span><span class="token punctuation">(</span>WeakReference<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span> entry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> entry<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>         bagEntry<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">,</span> STATE_IN_USE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> bagEntry<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul><li><strong>ThreadLocal 存储</strong>：每个线程有独立的列表，互不干扰</li><li><strong>从后往前遍历</strong>：优先取最近归还的连接</li><li><strong>CAS 状态切换</strong>：使用 <code>compareAndSet</code> 原子操作</li><li><strong>无锁设计</strong>：线程只访问自己的列表，无需同步</li></ul><h4 id="为什么优先使用？"><a href="#为什么优先使用？" class="headerlink" title="为什么优先使用？"></a>为什么优先使用？</h4><ul><li>✅ 无锁：线程只访问自己的列表，无需同步</li><li>✅ 缓存局部性：CPU 缓存命中率高</li><li>✅ 减少竞争：避免多线程争用共享资源</li></ul><h4 id="为什么是-List-而不是单个连接？"><a href="#为什么是-List-而不是单个连接？" class="headerlink" title="为什么是 List 而不是单个连接？"></a>为什么是 List 而不是单个连接？</h4><p>虽然大多数情况下线程只需要一个连接，但：</p><ol><li><strong>连接复用缓存</strong>：归还后可能很快又要用，缓存起来快速获取</li><li><strong>支持嵌套场景</strong>：一个线程可能需要多个连接（嵌套事务、并行查询）</li><li><strong>限制在50个</strong>：防止无限增长</li></ol><h3 id="第二层：共享列表（sharedList）"><a href="#第二层：共享列表（sharedList）" class="headerlink" title="第二层：共享列表（sharedList）"></a>第二层：共享列表（sharedList）</h3><h4 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Otherwise, scan the shared list</span><span class="token keyword">final</span> <span class="token keyword">int</span> waiting <span class="token operator">=</span> waiters<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>T bagEntry <span class="token operator">:</span> sharedList<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">,</span> STATE_IN_USE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 如果等待线程数 &gt; 1，触发补偿创建</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>waiting <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                listener<span class="token punctuation">.</span><span class="token function">addBagItem</span><span class="token punctuation">(</span>waiting <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> bagEntry<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 没有可用连接，触发创建新连接</span>    listener<span class="token punctuation">.</span><span class="token function">addBagItem</span><span class="token punctuation">(</span>waiting<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    waiters<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h4><ul><li><strong>共享资源</strong>：所有线程共享的 <code>CopyOnWriteArrayList</code></li><li><strong>线性扫描</strong>：遍历查找空闲连接</li><li><strong>CAS 竞争</strong>：多个线程可能同时尝试获取同一连接</li><li><strong>补偿机制</strong>：如果等待线程数 &gt; 1，触发创建新连接</li></ul><h4 id="关键变量"><a href="#关键变量" class="headerlink" title="关键变量"></a>关键变量</h4><ul><li><strong>sharedList</strong>：存储所有连接的全局列表</li><li><strong>waiters</strong>：统计当前等待连接的线程数</li><li><strong>listener</strong>：回调接口，当需要创建新连接时通知外部</li></ul><h3 id="第三层：等待队列（handoffQueue）"><a href="#第三层：等待队列（handoffQueue）" class="headerlink" title="第三层：等待队列（handoffQueue）"></a>第三层：等待队列（handoffQueue）</h3><h4 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 阻塞等待新连接</span>timeout <span class="token operator">=</span> timeUnit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> T bagEntry <span class="token operator">=</span> handoffQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bagEntry <span class="token operator">==</span> null <span class="token operator">||</span>         bagEntry<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>STATE_NOT_IN_USE<span class="token punctuation">,</span> STATE_IN_USE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> bagEntry<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    timeout <span class="token operator">-=</span> <span class="token function">elapsedNanos</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>timeout <span class="token operator">&gt;</span> 10_000<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h4><ul><li><strong>SynchronousQueue</strong>：无缓冲队列，生产者必须等待消费者</li><li><strong>阻塞等待</strong>：在超时内等待新连接</li><li><strong>直接交付</strong>：连接归还时如果有等待线程，直接放入队列</li></ul><h4 id="为什么需要？"><a href="#为什么需要？" class="headerlink" title="为什么需要？"></a>为什么需要？</h4><ul><li>当前无可用连接时，避免忙等待</li><li>连接归还时直接交付，减少唤醒延迟</li></ul><hr><h2 id="关键组件详解"><a href="#关键组件详解" class="headerlink" title="关键组件详解"></a>关键组件详解</h2><h3 id="1-aliveBypassWindowMs（健康检查窗口）"><a href="#1-aliveBypassWindowMs（健康检查窗口）" class="headerlink" title="1. aliveBypassWindowMs（健康检查窗口）"></a>1. aliveBypassWindowMs（健康检查窗口）</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> aliveBypassWindowMs <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>    <span class="token string">"com.zaxxer.hikari.aliveBypassWindowMs"</span><span class="token punctuation">,</span>     MILLISECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ul><li>默认 500ms 的时间窗口</li><li>在这个窗口内再次借出同一连接时，可以跳过昂贵的 <code>isConnectionAlive</code> 检查</li><li>超过窗口时间，需要重新检测连接是否存活</li></ul><h4 id="判断逻辑"><a href="#判断逻辑" class="headerlink" title="判断逻辑"></a>判断逻辑</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">elapsedMillis</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>lastAccessed<span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">&gt;</span> aliveBypassWindowMs     <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isConnectionAlive</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">.</span>connection<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 连接可能已失效，关闭并重试</span>    <span class="token function">closeConnection</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">,</span> DEAD_CONNECTION_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-isMarkedEvicted-（驱逐标记）"><a href="#2-isMarkedEvicted-（驱逐标记）" class="headerlink" title="2. isMarkedEvicted()（驱逐标记）"></a>2. isMarkedEvicted()（驱逐标记）</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">boolean</span> <span class="token function">isMarkedEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> evict<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">markEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>evict <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h4><ul><li>标记连接需要被驱逐</li><li>当连接被标记后，下次借出时会立即关闭</li></ul><h4 id="连接被淘汰的原因"><a href="#连接被淘汰的原因" class="headerlink" title="连接被淘汰的原因"></a>连接被淘汰的原因</h4><ol><li><strong>生命周期到期</strong>：超过 <code>maxLifetime</code></li><li><strong>空闲超时</strong>：超过 <code>idleTimeout</code></li><li><strong>健康检查失败</strong>：连接已失效</li><li><strong>显式驱逐</strong>：调用 <code>softEvictConnections()</code></li><li><strong>异常状态</strong>：连接状态异常</li></ol><h3 id="3-ProxyConnection-创建机制"><a href="#3-ProxyConnection-创建机制" class="headerlink" title="3. ProxyConnection 创建机制"></a>3. ProxyConnection 创建机制</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">return</span> poolEntry<span class="token punctuation">.</span><span class="token function">createProxyConnection</span><span class="token punctuation">(</span>    leakTaskFactory<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>poolEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><ol><li><strong>不创建新连接</strong>：<code>PoolEntry</code> 里已有真实连接</li><li><strong>创建代理对象</strong>：包装成 <code>ProxyConnection</code></li><li><strong>注册泄漏检测</strong>：启动定时任务监控连接是否泄漏</li></ol><h4 id="为什么需要代理？"><a href="#为什么需要代理？" class="headerlink" title="为什么需要代理？"></a>为什么需要代理？</h4><ul><li>拦截 <code>close()</code> 方法，归还到池中而不是真正关闭</li><li>跟踪 Statement，确保正确关闭</li><li>重置连接状态，保证连接可复用</li></ul><h3 id="4-泄漏检测机制"><a href="#4-泄漏检测机制" class="headerlink" title="4. 泄漏检测机制"></a>4. 泄漏检测机制</h3><h4 id="工作原理-3"><a href="#工作原理-3" class="headerlink" title="工作原理"></a>工作原理</h4><ul><li>配置 <code>leakDetectionThreshold</code>（毫秒）</li><li>每次借出连接时启动 <code>ProxyLeakTask</code></li><li>如果在该时间内连接未归还，记录警告日志</li></ul><h4 id="如何定位问题？"><a href="#如何定位问题？" class="headerlink" title="如何定位问题？"></a>如何定位问题？</h4><ul><li>日志包含借出时的调用栈</li><li>通过堆栈信息定位哪段代码忘记 <code>close()</code></li></ul><h3 id="5-构建阶段代码生成"><a href="#5-构建阶段代码生成" class="headerlink" title="5. 构建阶段代码生成"></a>5. 构建阶段代码生成</h3><h4 id="为什么需要？-1"><a href="#为什么需要？-1" class="headerlink" title="为什么需要？"></a>为什么需要？</h4><ul><li><code>ProxyFactory</code> 源码中只有占位方法</li><li>真正的代理类在构建时由 <code>JavassistProxyFactory</code> 生成</li><li>生成专用的字节码代理，性能优于 JDK 动态代理</li></ul><h4 id="构建配置"><a href="#构建配置" class="headerlink" title="构建配置"></a>构建配置</h4><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.codehaus.mojo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>exec-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">&gt;</span></span>java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arguments</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span><span class="token punctuation">&gt;</span></span>-cp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argument</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argument</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span><span class="token punctuation">&gt;</span></span>com.zaxxer.hikari.util.JavassistProxyFactory<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argument</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arguments</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="常见问题解答"><a href="#常见问题解答" class="headerlink" title="常见问题解答"></a>常见问题解答</h2><h3 id="Q1-为什么线程本地列表是-List-而不是单个连接？"><a href="#Q1-为什么线程本地列表是-List-而不是单个连接？" class="headerlink" title="Q1: 为什么线程本地列表是 List 而不是单个连接？"></a>Q1: 为什么线程本地列表是 List 而不是单个连接？</h3><p><strong>A:</strong> 虽然大多数情况下线程只需要一个连接，但：</p><ol><li><strong>连接复用缓存</strong>：归还后可能很快又要用</li><li><strong>支持嵌套场景</strong>：一个线程可能需要多个连接</li><li><strong>限制在50个</strong>：防止无限增长</li></ol><p>实际运行中，线程本地列表通常只有 0-2 个连接。</p><h3 id="Q2-requite-怎么读？是什么意思？"><a href="#Q2-requite-怎么读？是什么意思？" class="headerlink" title="Q2: requite 怎么读？是什么意思？"></a>Q2: requite 怎么读？是什么意思？</h3><p><strong>A:</strong> </p><ul><li><strong>发音</strong>：/rɪˈkwaɪt/，中文近似音：<strong>瑞-快特</strong></li><li><strong>含义</strong>：报答、回报、归还</li><li><strong>在代码中</strong>：表示将连接归还到池中</li></ul><h3 id="Q3-listener、waiters、sharedList-分别是什么？"><a href="#Q3-listener、waiters、sharedList-分别是什么？" class="headerlink" title="Q3: listener、waiters、sharedList 分别是什么？"></a>Q3: listener、waiters、sharedList 分别是什么？</h3><p><strong>A:</strong></p><ul><li><strong>sharedList</strong>：存储所有连接的全局共享列表（<code>CopyOnWriteArrayList</code>）</li><li><strong>waiters</strong>：统计当前等待连接的线程数（<code>AtomicInteger</code>）</li><li><strong>listener</strong>：回调接口，当需要创建新连接时通知 <code>HikariPool</code></li></ul><h3 id="Q4-handoffQueue-是干什么的？"><a href="#Q4-handoffQueue-是干什么的？" class="headerlink" title="Q4: handoffQueue 是干什么的？"></a>Q4: handoffQueue 是干什么的？</h3><p><strong>A:</strong> </p><ul><li><strong>作用</strong>：直接交付连接给等待线程</li><li><strong>类型</strong>：<code>SynchronousQueue</code>（无缓冲队列）</li><li><strong>优势</strong>：避免等待线程被唤醒后还要扫描共享列表</li></ul><h3 id="Q5-为什么用-CopyOnWriteArrayList？"><a href="#Q5-为什么用-CopyOnWriteArrayList？" class="headerlink" title="Q5: 为什么用 CopyOnWriteArrayList？"></a>Q5: 为什么用 CopyOnWriteArrayList？</h3><p><strong>A:</strong></p><ul><li><strong>读多写少</strong>：连接池中遍历查找是高频操作</li><li><strong>读操作无锁</strong>：多线程并发读取性能好</li><li><strong>线程安全</strong>：无需额外同步</li><li><strong>避免异常</strong>：遍历时不会因并发修改而抛异常</li></ul><h3 id="Q6-为什么不使用读写锁或-Vector？"><a href="#Q6-为什么不使用读写锁或-Vector？" class="headerlink" title="Q6: 为什么不使用读写锁或 Vector？"></a>Q6: 为什么不使用读写锁或 Vector？</h3><p><strong>A:</strong></p><table><thead><tr><th>方案</th><th>问题</th></tr></thead><tbody><tr><td><strong>Vector</strong></td><td>所有操作都加锁，性能差</td></tr><tr><td><strong>ArrayList + synchronized</strong></td><td>读操作被写操作阻塞</td></tr><tr><td><strong>ReadWriteLock</strong></td><td>仍有锁开销，写操作会阻塞读操作</td></tr><tr><td><strong>CopyOnWriteArrayList</strong></td><td>✅ 读操作完全无锁，性能最优</td></tr></tbody></table><hr><h2 id="设计决策分析"><a href="#设计决策分析" class="headerlink" title="设计决策分析"></a>设计决策分析</h2><h3 id="CopyOnWriteArrayList-vs-ReadWriteLock"><a href="#CopyOnWriteArrayList-vs-ReadWriteLock" class="headerlink" title="CopyOnWriteArrayList vs ReadWriteLock"></a>CopyOnWriteArrayList vs ReadWriteLock</h3><h4 id="CopyOnWriteArrayList-的优势"><a href="#CopyOnWriteArrayList-的优势" class="headerlink" title="CopyOnWriteArrayList 的优势"></a>CopyOnWriteArrayList 的优势</h4><ol><li>✅ <strong>读操作完全无锁</strong>，性能最优</li><li>✅ <strong>读操作不会被写操作阻塞</strong></li><li>✅ <strong>实现简单</strong>，无死锁风险</li><li>✅ <strong>适合读多写少的场景</strong></li></ol><h4 id="ReadWriteLock-的优势"><a href="#ReadWriteLock-的优势" class="headerlink" title="ReadWriteLock 的优势"></a>ReadWriteLock 的优势</h4><ol><li>✅ <strong>数据实时性好</strong>（不是快照）</li><li>✅ <strong>写操作性能更好</strong>（不复制数组）</li><li>✅ <strong>内存占用更少</strong></li><li>✅ <strong>适合读写均衡或写多读少的场景</strong></li></ol><h4 id="选择建议"><a href="#选择建议" class="headerlink" title="选择建议"></a>选择建议</h4><ul><li><strong>读多写少</strong> → CopyOnWriteArrayList（如连接池）✓</li><li><strong>读写均衡</strong> → ReadWriteLock</li><li><strong>写多读少</strong> → ReadWriteLock</li><li><strong>需要实时数据</strong> → ReadWriteLock</li><li><strong>需要最高读性能</strong> → CopyOnWriteArrayList</li></ul><h3 id="为什么选择三层查找机制？"><a href="#为什么选择三层查找机制？" class="headerlink" title="为什么选择三层查找机制？"></a>为什么选择三层查找机制？</h3><h4 id="设计优势"><a href="#设计优势" class="headerlink" title="设计优势"></a>设计优势</h4><ol><li><strong>性能优化</strong>：优先使用线程本地列表，减少锁竞争</li><li><strong>负载均衡</strong>：共享列表允许线程间共享连接</li><li><strong>及时响应</strong>：等待队列直接交付，减少唤醒延迟</li><li><strong>无锁设计</strong>：大量使用 CAS，避免传统锁的开销</li><li><strong>自适应</strong>：根据等待线程数动态创建连接</li></ol><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>HikariCP 的连接池设计体现了以下核心思想：</p><ol><li><strong>无锁优先</strong>：尽可能使用无锁设计（CAS、ThreadLocal）</li><li><strong>读多写少优化</strong>：针对连接池场景优化（CopyOnWriteArrayList）</li><li><strong>三层查找</strong>：线程本地 → 共享列表 → 等待队列</li><li><strong>直接交付</strong>：使用 handoffQueue 减少延迟</li><li><strong>健康检查</strong>：aliveBypassWindowMs 平衡性能和可靠性</li></ol><p>这些设计使得 HikariCP 在保证线程安全的同时，实现了极高的并发性能。</p><hr><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li>HikariCP 源码：<code>src/main/java/com/zaxxer/hikari/</code></li><li>关键类：<ul><li><code>HikariPool.java</code>：连接池主类</li><li><code>ConcurrentBag.java</code>：连接容器</li><li><code>PoolEntry.java</code>：连接条目</li><li><code>ProxyConnection.java</code>：代理连接</li></ul></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>本博客搭建详细教程</title>
      <link href="/posts/9294.html"/>
      <url>/posts/9294.html</url>
      
        <content type="html"><![CDATA[<h2 id="本博客详细教程地址："><a href="#本博客详细教程地址：" class="headerlink" title="本博客详细教程地址："></a>本博客详细教程地址：</h2><p>系列教程：</p><ul><li><a href="http://sitoi.cn/posts/6666.html">基于 Hexo GitHub 从零开始搭建个人博客（一）：环境准备篇</a></li><li><a href="https://sitoi.cn/posts/27801.html">基于 Hexo GitHub 从零开始搭建个人博客（二）：搭建基础篇</a></li><li><a href="https://sitoi.cn/posts/63466.html">基于 Hexo GitHub 从零开始搭建个人博客（三）：Matery 主题（DIY 版）详细配置教程，附博客源码</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java NIO Buffer 使用与实现原理</title>
      <link href="/posts/102.html"/>
      <url>/posts/102.html</url>
      
        <content type="html"><![CDATA[<p>这是第一篇博客</p><h1 id="Java-NIO-Buffer-使用与实现原理"><a href="#Java-NIO-Buffer-使用与实现原理" class="headerlink" title="Java NIO Buffer 使用与实现原理"></a>Java NIO Buffer 使用与实现原理</h1><h2 id="1-Buffer-概述"><a href="#1-Buffer-概述" class="headerlink" title="1. Buffer 概述"></a>1. Buffer 概述</h2><h3 id="1-1-什么是-Buffer"><a href="#1-1-什么是-Buffer" class="headerlink" title="1.1 什么是 Buffer"></a>1.1 什么是 Buffer</h3><p>Buffer（缓冲区）是 Java NIO 中用于与通道（Channel）进行数据交互的对象。它是一个线性的、有限的数据容器，本质上是一个数组，但提供了更丰富的操作接口。</p><h3 id="1-2-Buffer-的核心特性"><a href="#1-2-Buffer-的核心特性" class="headerlink" title="1.2 Buffer 的核心特性"></a>1.2 Buffer 的核心特性</h3><ul><li><strong>容量（Capacity）</strong>：Buffer 的最大数据容量，创建后不可改变</li><li><strong>位置（Position）</strong>：下一个要读取或写入的索引位置</li><li><strong>限制（Limit）</strong>：第一个不应该读取或写入的索引位置</li><li><strong>标记（Mark）</strong>：一个备忘位置，可以通过 <code>reset()</code> 恢复到该位置</li></ul><h3 id="1-3-Buffer-的类型"><a href="#1-3-Buffer-的类型" class="headerlink" title="1.3 Buffer 的类型"></a>1.3 Buffer 的类型</h3><p>Java NIO 提供了以下类型的 Buffer：</p><ul><li><code>ByteBuffer</code></li><li><code>CharBuffer</code></li><li><code>ShortBuffer</code></li><li><code>IntBuffer</code></li><li><code>LongBuffer</code></li><li><code>FloatBuffer</code></li><li><code>DoubleBuffer</code></li></ul><p>其中 <code>ByteBuffer</code> 是最常用的，其他类型都是基于 <code>ByteBuffer</code> 的视图。</p><h2 id="2-Buffer-的基本使用"><a href="#2-Buffer-的基本使用" class="headerlink" title="2. Buffer 的基本使用"></a>2. Buffer 的基本使用</h2><h3 id="2-1-创建-Buffer"><a href="#2-1-创建-Buffer" class="headerlink" title="2.1 创建 Buffer"></a>2.1 创建 Buffer</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 方式1：分配指定容量的 Buffer（堆内存）</span>ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式2：分配直接内存 Buffer（堆外内存）</span>ByteBuffer directBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式3：包装现有数组</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ByteBuffer wrappedBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-写入数据到-Buffer"><a href="#2-2-写入数据到-Buffer" class="headerlink" title="2.2 写入数据到 Buffer"></a>2.2 写入数据到 Buffer</h3><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式1：使用 put() 方法</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'H'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'o'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式2：批量写入</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式3：从 Channel 读取数据到 Buffer</span>channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-3-从-Buffer-读取数据"><a href="#2-3-从-Buffer-读取数据" class="headerlink" title="2.3 从 Buffer 读取数据"></a>2.3 从 Buffer 读取数据</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 切换为读模式</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式1：逐个读取</span><span class="token keyword">while</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 方式2：批量读取</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式3：写入到 Channel</span>channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-4-Buffer-的状态转换"><a href="#2-4-Buffer-的状态转换" class="headerlink" title="2.4 Buffer 的状态转换"></a>2.4 Buffer 的状态转换</h3><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 初始状态：position=0, limit=capacity</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"初始: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 写入数据后：position 移动到写入位置</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写入后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// flip()：切换为读模式，limit=position, position=0</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"flip后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 读取数据后：position 移动到读取位置</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读取后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// rewind()：重新读取，position=0, limit 不变</span>buffer<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rewind后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// clear()：清空 Buffer，position=0, limit=capacity（但数据未清除）</span>buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"clear后: position="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", limit="</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-Buffer-核心方法详解"><a href="#3-Buffer-核心方法详解" class="headerlink" title="3. Buffer 核心方法详解"></a>3. Buffer 核心方法详解</h2><h3 id="3-1-flip-切换为读模式"><a href="#3-1-flip-切换为读模式" class="headerlink" title="3.1 flip() - 切换为读模式"></a>3.1 flip() - 切换为读模式</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    limit <span class="token operator">=</span> position<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 将 limit 设置为当前 position</span>    position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 将 position 重置为 0</span>    mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 清除标记</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>使用场景</strong>：写入数据后，准备读取数据时调用。</p><h3 id="3-2-clear-清空-Buffer"><a href="#3-2-clear-清空-Buffer" class="headerlink" title="3.2 clear() - 清空 Buffer"></a>3.2 clear() - 清空 Buffer</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// position 重置为 0</span>    limit <span class="token operator">=</span> capacity<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// limit 设置为 capacity</span>    mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 清除标记</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意</strong>：<code>clear()</code> 不会清除 Buffer 中的数据，只是重置了位置指针，数据仍然存在。</p><h3 id="3-3-rewind-重新读取"><a href="#3-3-rewind-重新读取" class="headerlink" title="3.3 rewind() - 重新读取"></a>3.3 rewind() - 重新读取</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// position 重置为 0</span>    mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 清除标记</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>使用场景</strong>：需要重新读取 Buffer 中的数据，但 limit 保持不变。</p><h3 id="3-4-compact-压缩-Buffer"><a href="#3-4-compact-压缩-Buffer" class="headerlink" title="3.4 compact() - 压缩 Buffer"></a>3.4 compact() - 压缩 Buffer</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> ByteBuffer <span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>hb<span class="token punctuation">,</span> <span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hb<span class="token punctuation">,</span> <span class="token function">ix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">position</span><span class="token punctuation">(</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">limit</span><span class="token punctuation">(</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">discardMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>作用</strong>：将未读取的数据移动到 Buffer 的开头，为后续写入腾出空间。</p><p><strong>使用场景</strong>：部分读取数据后，需要继续写入新数据。</p><h3 id="3-5-mark-和-reset-标记和重置"><a href="#3-5-mark-和-reset-标记和重置" class="headerlink" title="3.5 mark() 和 reset() - 标记和重置"></a>3.5 mark() 和 reset() - 标记和重置</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    mark <span class="token operator">=</span> position<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 记录当前 position</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">final</span> Buffer <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> m <span class="token operator">=</span> mark<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidMarkException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    position <span class="token operator">=</span> m<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 恢复到标记位置</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-Buffer-实现原理深度剖析"><a href="#4-Buffer-实现原理深度剖析" class="headerlink" title="4. Buffer 实现原理深度剖析"></a>4. Buffer 实现原理深度剖析</h2><h3 id="4-1-Buffer-的类层次结构"><a href="#4-1-Buffer-的类层次结构" class="headerlink" title="4.1 Buffer 的类层次结构"></a>4.1 Buffer 的类层次结构</h3><pre><code>Buffer (抽象类)  ├── ByteBuffer (抽象类)  │   ├── HeapByteBuffer (堆内存实现)  │   └── DirectByteBuffer (直接内存实现)  ├── CharBuffer  ├── ShortBuffer  ├── IntBuffer  ├── LongBuffer  ├── FloatBuffer  └── DoubleBuffer</code></pre><h3 id="4-2-Buffer-核心字段"><a href="#4-2-Buffer-核心字段" class="headerlink" title="4.2 Buffer 核心字段"></a>4.2 Buffer 核心字段</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Buffer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 标记位置</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 当前位置</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 限制位置</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> limit<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 容量</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 地址（用于直接内存）</span>    <span class="token keyword">long</span> address<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-3-HeapByteBuffer-实现"><a href="#4-3-HeapByteBuffer-实现" class="headerlink" title="4.3 HeapByteBuffer 实现"></a>4.3 HeapByteBuffer 实现</h3><h4 id="4-3-1-内部结构"><a href="#4-3-1-内部结构" class="headerlink" title="4.3.1 内部结构"></a>4.3.1 内部结构</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">HeapByteBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">ByteBuffer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 底层数组</span>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hb<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 数组偏移量</span>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> offset<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 是否为只读</span>    <span class="token keyword">boolean</span> isReadOnly<span class="token punctuation">;</span>    <span class="token function">HeapByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>cap<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// hb 在父类中初始化</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-3-2-数据访问实现"><a href="#4-3-2-数据访问实现" class="headerlink" title="4.3.2 数据访问实现"></a>4.3.2 数据访问实现</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 获取数据</span><span class="token keyword">public</span> <span class="token keyword">byte</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">nextGetIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">byte</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">checkIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 写入数据</span><span class="token keyword">public</span> ByteBuffer <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">byte</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">nextPutIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> ByteBuffer <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">byte</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    hb<span class="token punctuation">[</span><span class="token function">ix</span><span class="token punctuation">(</span><span class="token function">checkIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 计算实际索引</span><span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">ix</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> i <span class="token operator">+</span> offset<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li><code>HeapByteBuffer</code> 使用 Java 堆内存中的 <code>byte[]</code> 数组</li><li>所有操作都是对数组的直接访问</li><li>受 GC 管理，内存分配和回收由 JVM 控制</li></ul><h3 id="4-4-DirectByteBuffer-实现"><a href="#4-4-DirectByteBuffer-实现" class="headerlink" title="4.4 DirectByteBuffer 实现"></a>4.4 DirectByteBuffer 实现</h3><h4 id="4-4-1-内部结构"><a href="#4-4-1-内部结构" class="headerlink" title="4.4.1 内部结构"></a>4.4.1 内部结构</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DirectByteBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">MappedByteBuffer</span> <span class="token keyword">implements</span> <span class="token class-name">DirectBuffer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 直接内存地址</span>    <span class="token keyword">protected</span> <span class="token keyword">long</span> address<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 内存分配器</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Cleaner cleaner<span class="token punctuation">;</span>    <span class="token function">DirectByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cap<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> pa <span class="token operator">=</span> VM<span class="token punctuation">.</span><span class="token function">isDirectMemoryPageAligned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> ps <span class="token operator">=</span> Bits<span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> size <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>cap <span class="token operator">+</span> <span class="token punctuation">(</span>pa <span class="token operator">?</span> ps <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Bits<span class="token punctuation">.</span><span class="token function">reserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 分配直接内存</span>            base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Bits<span class="token punctuation">.</span><span class="token function">unreserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> x<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>base <span class="token operator">%</span> ps <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            address <span class="token operator">=</span> base <span class="token operator">+</span> ps <span class="token operator">-</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            address <span class="token operator">=</span> base<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 创建清理器，用于释放直接内存</span>        cleaner <span class="token operator">=</span> Cleaner<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Deallocator</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        att <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-4-2-内存分配机制"><a href="#4-4-2-内存分配机制" class="headerlink" title="4.4.2 内存分配机制"></a>4.4.2 内存分配机制</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 使用 Unsafe 分配直接内存</span><span class="token keyword">long</span> base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置内存内容</span>unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 计算对齐后的地址</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>base <span class="token operator">%</span> ps <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    address <span class="token operator">=</span> base <span class="token operator">+</span> ps <span class="token operator">-</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    address <span class="token operator">=</span> base<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li><code>DirectByteBuffer</code> 使用堆外内存（直接内存）</li><li>通过 <code>Unsafe.allocateMemory()</code> 分配</li><li>不受 GC 直接管理，需要手动释放</li><li>使用 <code>Cleaner</code> 机制在对象被 GC 时自动释放内存</li></ul><h4 id="4-4-3-内存释放机制"><a href="#4-4-3-内存释放机制" class="headerlink" title="4.4.3 内存释放机制"></a>4.4.3 内存释放机制</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Deallocator</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Unsafe unsafe <span class="token operator">=</span> Unsafe<span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> address<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Deallocator</span><span class="token punctuation">(</span><span class="token keyword">long</span> address<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">assert</span> <span class="token punctuation">(</span>address <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>address <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 释放直接内存</span>        unsafe<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>        address <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        Bits<span class="token punctuation">.</span><span class="token function">unreserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>内存释放流程</strong>：</p><ol><li><code>DirectByteBuffer</code> 对象被 GC 回收</li><li><code>Cleaner</code> 检测到对象被回收</li><li>调用 <code>Deallocator.run()</code> 释放直接内存</li><li>调用 <code>Unsafe.freeMemory()</code> 释放内存</li></ol><h3 id="4-5-Buffer-的视图机制"><a href="#4-5-Buffer-的视图机制" class="headerlink" title="4.5 Buffer 的视图机制"></a>4.5 Buffer 的视图机制</h3><h4 id="4-5-1-创建视图"><a href="#4-5-1-创建视图" class="headerlink" title="4.5.1 创建视图"></a>4.5.1 创建视图</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 创建只读视图</span><span class="token keyword">public</span> ByteBuffer <span class="token function">asReadOnlyBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapByteBufferR</span><span class="token punctuation">(</span>hb<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">markValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 创建其他类型的视图</span><span class="token keyword">public</span> CharBuffer <span class="token function">asCharBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> off <span class="token operator">=</span> offset <span class="token operator">+</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>bigEndian            <span class="token operator">?</span> <span class="token punctuation">(</span>CharBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteBufferAsCharBufferB</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token operator">:</span> <span class="token punctuation">(</span>CharBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteBufferAsCharBufferL</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-5-2-视图共享机制"><a href="#4-5-2-视图共享机制" class="headerlink" title="4.5.2 视图共享机制"></a>4.5.2 视图共享机制</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 视图 Buffer 共享底层数组</span><span class="token keyword">class</span> <span class="token class-name">HeapByteBufferR</span> <span class="token keyword">extends</span> <span class="token class-name">HeapByteBuffer</span> <span class="token punctuation">{</span>    <span class="token function">HeapByteBufferR</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> mark<span class="token punctuation">,</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">,</span> <span class="token keyword">int</span> cap<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> mark<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isReadOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 标记为只读</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 所有修改操作都抛出异常</span>    <span class="token keyword">public</span> ByteBuffer <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">byte</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReadOnlyBufferException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li>视图 Buffer 共享底层数据数组</li><li>修改一个 Buffer 会影响其他视图</li><li>但每个视图有独立的 position、limit、mark</li></ul><h3 id="4-6-Buffer-的字节序（ByteOrder）"><a href="#4-6-Buffer-的字节序（ByteOrder）" class="headerlink" title="4.6 Buffer 的字节序（ByteOrder）"></a>4.6 Buffer 的字节序（ByteOrder）</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ByteBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">Buffer</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token operator">&lt;</span>ByteBuffer<span class="token operator">&gt;</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 字节序：大端（BIG_ENDIAN）或小端（LITTLE_ENDIAN）</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> bigEndian<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 默认使用大端序</span>    <span class="token function">ByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> mark<span class="token punctuation">,</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">,</span> <span class="token keyword">int</span> cap<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hb<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>mark<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>hb <span class="token operator">=</span> hb<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>bigEndian <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 默认大端序</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 设置字节序</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ByteBuffer <span class="token function">order</span><span class="token punctuation">(</span>ByteOrder bo<span class="token punctuation">)</span> <span class="token punctuation">{</span>        bigEndian <span class="token operator">=</span> <span class="token punctuation">(</span>bo <span class="token operator">==</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span><span class="token punctuation">;</span>        nativeByteOrder <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>字节序影响</strong>：</p><ul><li>多字节数据类型（int、long 等）的存储顺序</li><li>大端序：高位字节在前（网络字节序）</li><li>小端序：低位字节在前（x86 架构默认）</li></ul><h2 id="5-Buffer-使用最佳实践"><a href="#5-Buffer-使用最佳实践" class="headerlink" title="5. Buffer 使用最佳实践"></a>5. Buffer 使用最佳实践</h2><h3 id="5-1-堆内存-vs-直接内存"><a href="#5-1-堆内存-vs-直接内存" class="headerlink" title="5.1 堆内存 vs 直接内存"></a>5.1 堆内存 vs 直接内存</h3><table><thead><tr><th>特性</th><th>HeapByteBuffer</th><th>DirectByteBuffer</th></tr></thead><tbody><tr><td>内存位置</td><td>堆内存</td><td>堆外内存</td></tr><tr><td>分配速度</td><td>快</td><td>慢</td></tr><tr><td>访问速度</td><td>相对慢</td><td>相对快</td></tr><tr><td>GC 管理</td><td>是</td><td>否（通过 Cleaner）</td></tr><tr><td>适用场景</td><td>小数据量、频繁创建</td><td>大数据量、长期存在</td></tr></tbody></table><h3 id="5-2-使用建议"><a href="#5-2-使用建议" class="headerlink" title="5.2 使用建议"></a>5.2 使用建议</h3><ol><li><p><strong>选择合适的 Buffer 类型</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 小数据量、临时使用</span>ByteBuffer heapBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 大数据量、需要与操作系统交互</span>ByteBuffer directBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>正确使用 flip() 和 clear()</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 写入数据后准备读取</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 读取完成后准备重新写入</span>buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 部分读取后继续写入</span>buffer<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>避免频繁创建 Buffer</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 不好的做法</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 使用 buffer</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 好的做法：复用 Buffer</span>ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 使用 buffer</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>注意直接内存的释放</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// DirectByteBuffer 会在 GC 时自动释放</span><span class="token comment" spellcheck="true">// 但可以通过以下方式显式释放（不推荐）</span>DirectBuffer db <span class="token operator">=</span> <span class="token punctuation">(</span>DirectBuffer<span class="token punctuation">)</span> directBuffer<span class="token punctuation">;</span>Cleaner cleaner <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">cleaner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>cleaner <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    cleaner<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="5-3-常见错误和陷阱"><a href="#5-3-常见错误和陷阱" class="headerlink" title="5.3 常见错误和陷阱"></a>5.3 常见错误和陷阱</h3><ol><li><p><strong>忘记调用 flip()</strong></p><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 错误：没有调用 flip()，position 在末尾，读取不到数据</span><span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 会抛出 BufferUnderflowException</span><span class="token comment" spellcheck="true">// 正确做法</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 正常读取</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>clear() 不会清除数据</strong></p><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 数据仍然存在，只是 position 和 limit 被重置</span><span class="token comment" spellcheck="true">// 如果需要清除数据，需要手动覆盖</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>视图 Buffer 共享数据</strong></p><pre class="line-numbers language-java"><code class="language-java">ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ByteBuffer view <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">duplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>view<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'h'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 修改视图</span><span class="token comment" spellcheck="true">// 原 buffer 的数据也被修改了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="6-Buffer-性能优化"><a href="#6-Buffer-性能优化" class="headerlink" title="6. Buffer 性能优化"></a>6. Buffer 性能优化</h2><h3 id="6-1-批量操作"><a href="#6-1-批量操作" class="headerlink" title="6.1 批量操作"></a>6.1 批量操作</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 单个操作（慢）</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 批量操作（快）</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-2-使用-slice-避免复制"><a href="#6-2-使用-slice-避免复制" class="headerlink" title="6.2 使用 slice() 避免复制"></a>6.2 使用 slice() 避免复制</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 不需要复制数据，创建子 Buffer</span>ByteBuffer subBuffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>subBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>subBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 操作 subBuffer 不会影响原 buffer 的 position 和 limit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-3-直接内存的合理使用"><a href="#6-3-直接内存的合理使用" class="headerlink" title="6.3 直接内存的合理使用"></a>6.3 直接内存的合理使用</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 对于需要与操作系统交互的场景，使用直接内存</span><span class="token comment" spellcheck="true">// 例如：文件 I/O、网络 I/O</span>FileChannel channel <span class="token operator">=</span> FileChannel<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> StandardOpenOption<span class="token punctuation">.</span>READ<span class="token punctuation">)</span><span class="token punctuation">;</span>ByteBuffer directBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>directBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><h3 id="7-1-核心要点"><a href="#7-1-核心要点" class="headerlink" title="7.1 核心要点"></a>7.1 核心要点</h3><ol><li><strong>Buffer 的四个核心属性</strong>：capacity、position、limit、mark</li><li><strong>状态转换</strong>：通过 <code>flip()</code>、<code>clear()</code>、<code>rewind()</code>、<code>compact()</code> 等方法切换状态</li><li><strong>两种实现</strong>：<code>HeapByteBuffer</code>（堆内存）和 <code>DirectByteBuffer</code>（直接内存）</li><li><strong>视图机制</strong>：可以创建只读视图、类型视图等，共享底层数据</li></ol><h3 id="7-2-实现原理要点"><a href="#7-2-实现原理要点" class="headerlink" title="7.2 实现原理要点"></a>7.2 实现原理要点</h3><ol><li><strong>HeapByteBuffer</strong>：基于 Java 数组，受 GC 管理，访问速度相对较慢</li><li><strong>DirectByteBuffer</strong>：使用堆外内存，通过 <code>Unsafe</code> 分配，使用 <code>Cleaner</code> 自动释放</li><li><strong>字节序</strong>：影响多字节数据类型的存储和读取顺序</li><li><strong>视图共享</strong>：多个视图 Buffer 共享底层数组，但各自维护独立的 position、limit、mark</li></ol><h3 id="7-3-使用建议"><a href="#7-3-使用建议" class="headerlink" title="7.3 使用建议"></a>7.3 使用建议</h3><ul><li>根据场景选择合适的 Buffer 类型</li><li>正确使用状态转换方法</li><li>避免频繁创建 Buffer，尽量复用</li><li>注意直接内存的使用和释放</li><li>使用批量操作提高性能</li></ul><hr><p><strong>参考资源</strong>：</p><ul><li><a href="https://docs.oracle.com/javase/8/docs/api/java/nio/Buffer.html">Java NIO Buffer 官方文档</a></li><li><a href="https://jenkov.com/tutorials/java-nio/buffers.html">Java NIO 教程</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot事务实现原理</title>
      <link href="/posts/104.html"/>
      <url>/posts/104.html</url>
      
        <content type="html"><![CDATA[<h1 id="Spring-事务机制详解"><a href="#Spring-事务机制详解" class="headerlink" title="Spring 事务机制详解"></a>Spring 事务机制详解</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol><li><a href="#1-spring-transactional-实现原理">Spring @Transactional 实现原理</a></li><li><a href="#2-spring-aop-与-aspectj-的关系">Spring AOP 与 AspectJ 的关系</a></li><li><a href="#3-cglib-与-aspectj-的关系">CGLIB 与 AspectJ 的关系</a></li><li><a href="#4-代理类的生成时机">代理类的生成时机</a></li><li><a href="#5-事务传播行为详解">事务传播行为详解</a></li><li><a href="#6-事务隔离级别">事务隔离级别</a></li><li><a href="#7-transactioninterceptor-实现原理">TransactionInterceptor 实现原理</a></li></ol><hr><h2 id="1-Spring-Transactional-实现原理"><a href="#1-Spring-Transactional-实现原理" class="headerlink" title="1. Spring @Transactional 实现原理"></a>1. Spring @Transactional 实现原理</h2><h3 id="1-1-核心机制：AOP（面向切面编程）"><a href="#1-1-核心机制：AOP（面向切面编程）" class="headerlink" title="1.1 核心机制：AOP（面向切面编程）"></a>1.1 核心机制：AOP（面向切面编程）</h3><p><code>@Transactional</code> 基于 Spring AOP，通过代理对象拦截方法调用，在方法执行前后添加事务逻辑。</p><h3 id="1-2-实现流程"><a href="#1-2-实现流程" class="headerlink" title="1.2 实现流程"></a>1.2 实现流程</h3><h4 id="1-2-1-注解扫描与处理"><a href="#1-2-1-注解扫描与处理" class="headerlink" title="1.2.1 注解扫描与处理"></a>1.2.1 注解扫描与处理</h4><p>Spring 在启动时扫描 <code>@Transactional</code>，由 <code>TransactionInterceptor</code> 处理：</p><ul><li><code>@EnableTransactionManagement</code> 启用事务管理</li><li><code>TransactionAttributeSourceAdvisor</code> 识别带 <code>@Transactional</code> 的方法</li><li>创建代理对象（JDK 动态代理或 CGLIB）</li></ul><h4 id="1-2-2-方法拦截执行流程"><a href="#1-2-2-方法拦截执行流程" class="headerlink" title="1.2.2 方法拦截执行流程"></a>1.2.2 方法拦截执行流程</h4><p>当调用带 <code>@Transactional</code> 的方法时：</p><pre><code>1. 代理对象拦截方法调用   ↓2. TransactionInterceptor.invoke()   ↓3. 获取事务属性（传播行为、隔离级别等）   ↓4. 获取或创建事务（PlatformTransactionManager）   ↓5. 执行业务方法   ↓6. 根据执行结果提交或回滚事务</code></pre><h3 id="1-3-关键组件"><a href="#1-3-关键组件" class="headerlink" title="1.3 关键组件"></a>1.3 关键组件</h3><ul><li><strong>TransactionInterceptor</strong>：核心拦截器，负责方法拦截、事务属性解析、事务管理器调用</li><li><strong>PlatformTransactionManager</strong>：事务管理器接口<ul><li><code>DataSourceTransactionManager</code>（JDBC）</li><li><code>HibernateTransactionManager</code>（Hibernate）</li><li><code>JpaTransactionManager</code>（JPA）</li></ul></li><li><strong>TransactionAttributeSource</strong>：解析 <code>@Transactional</code> 属性</li></ul><h3 id="1-4-注意事项"><a href="#1-4-注意事项" class="headerlink" title="1.4 注意事项"></a>1.4 注意事项</h3><h4 id="代理失效场景"><a href="#代理失效场景" class="headerlink" title="代理失效场景"></a>代理失效场景</h4><ul><li>同一个类内部方法调用（绕过代理）</li><li>方法不是 public</li><li>异常被捕获未抛出</li></ul><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ❌ 错误示例：内部调用不会触发事务</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 不会走代理</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Transactional</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 事务不会生效</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ✅ 正确：通过注入的代理对象调用</span><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> UserService self<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注入代理对象</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        self<span class="token punctuation">.</span><span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 会走代理，事务生效</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Transactional</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 事务生效</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="2-Spring-AOP-与-AspectJ-的关系"><a href="#2-Spring-AOP-与-AspectJ-的关系" class="headerlink" title="2. Spring AOP 与 AspectJ 的关系"></a>2. Spring AOP 与 AspectJ 的关系</h2><h3 id="2-1-核心区别"><a href="#2-1-核心区别" class="headerlink" title="2.1 核心区别"></a>2.1 核心区别</h3><p><strong>Spring AOP 和 AspectJ 不是同一级别的</strong>，它们是两种不同的 AOP 实现方式：</p><pre><code>AOP 实现方式（顶层）    ├── Spring AOP（一种实现方式）    │   └── 使用代理模式    │       ├── JDK 动态代理    │       └── CGLIB 代理    │    └── AspectJ（另一种实现方式）        └── 使用字节码织入（不是代理）            ├── 编译时织入            ├── 编译后织入            └── 加载时织入（LTW）</code></pre><h3 id="2-2-Spring-AOP：运行时动态代理"><a href="#2-2-Spring-AOP：运行时动态代理" class="headerlink" title="2.2 Spring AOP：运行时动态代理"></a>2.2 Spring AOP：运行时动态代理</h3><h4 id="实现方式："><a href="#实现方式：" class="headerlink" title="实现方式："></a>实现方式：</h4><ul><li><strong>JDK 动态代理</strong>：基于接口，使用 <code>java.lang.reflect.Proxy</code></li><li><strong>CGLIB 代理</strong>：基于子类继承，运行时生成字节码</li></ul><h4 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h4><ul><li>在运行时生成代理对象</li><li>仅支持方法级别的拦截</li><li>仅支持 Spring Bean</li></ul><h3 id="2-3-AspectJ：编译时-加载时织入（不是动态代理）"><a href="#2-3-AspectJ：编译时-加载时织入（不是动态代理）" class="headerlink" title="2.3 AspectJ：编译时/加载时织入（不是动态代理）"></a>2.3 AspectJ：编译时/加载时织入（不是动态代理）</h3><h4 id="织入时机："><a href="#织入时机：" class="headerlink" title="织入时机："></a>织入时机：</h4><ul><li><strong>编译时织入</strong>：编译时修改字节码</li><li><strong>编译后织入</strong>：对已编译的 .class 文件进行织入</li><li><strong>加载时织入</strong>：类加载时通过 ClassLoader 织入</li></ul><h4 id="特点：-1"><a href="#特点：-1" class="headerlink" title="特点："></a>特点：</h4><ul><li>不是动态代理，而是字节码织入</li><li>支持字段、构造器、静态初始化等</li><li>支持任意 Java 类</li></ul><h3 id="2-4-对比总结"><a href="#2-4-对比总结" class="headerlink" title="2.4 对比总结"></a>2.4 对比总结</h3><table><thead><tr><th>特性</th><th>Spring AOP</th><th>AspectJ</th></tr></thead><tbody><tr><td>实现方式</td><td>动态代理（运行时）</td><td>字节码织入</td></tr><tr><td>织入时机</td><td>运行时</td><td>编译时/编译后/加载时</td></tr><tr><td>性能</td><td>相对较慢（代理调用）</td><td>更快（直接执行）</td></tr><tr><td>功能范围</td><td>仅方法级别</td><td>字段、构造器、静态初始化等</td></tr><tr><td>依赖</td><td>仅 Spring 容器</td><td>需要 AspectJ 编译器/Weaver</td></tr><tr><td>限制</td><td>仅 Spring Bean</td><td>任意 Java 类</td></tr></tbody></table><h3 id="2-5-Spring-中使用-AspectJ-的方式"><a href="#2-5-Spring-中使用-AspectJ-的方式" class="headerlink" title="2.5 Spring 中使用 AspectJ 的方式"></a>2.5 Spring 中使用 AspectJ 的方式</h3><h4 id="方式一：Spring-AOP（默认，运行时代理）"><a href="#方式一：Spring-AOP（默认，运行时代理）" class="headerlink" title="方式一：Spring AOP（默认，运行时代理）"></a>方式一：Spring AOP（默认，运行时代理）</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 使用 AspectJ 注解风格，但底层是 Spring AOP</span><span class="token annotation punctuation">@Aspect</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAspect</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"execution(* com.example.*.*(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>需要 <code>@EnableAspectJAutoProxy</code></li><li>运行时动态代理</li><li>仅支持 Spring Bean</li></ul><h4 id="方式二：AspectJ-LTW（加载时织入）"><a href="#方式二：AspectJ-LTW（加载时织入）" class="headerlink" title="方式二：AspectJ LTW（加载时织入）"></a>方式二：AspectJ LTW（加载时织入）</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 需要配置 aop.xml</span><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@EnableLoadTimeWeaving</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AspectJConfig</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>需要 <code>aspectjweaver.jar</code></li><li>类加载时织入</li><li>支持任意 Java 类</li></ul><hr><h2 id="3-CGLIB-与-AspectJ-的关系"><a href="#3-CGLIB-与-AspectJ-的关系" class="headerlink" title="3. CGLIB 与 AspectJ 的关系"></a>3. CGLIB 与 AspectJ 的关系</h2><h3 id="3-1-核心关系总结"><a href="#3-1-核心关系总结" class="headerlink" title="3.1 核心关系总结"></a>3.1 核心关系总结</h3><ul><li><strong>CGLIB 和 AspectJ 是两种不同的技术</strong>，用于不同的目的</li><li><strong>Spring AOP 使用 CGLIB 作为代理实现方式之一</strong></li><li><strong>AspectJ 提供切点表达式解析</strong>，Spring AOP 借用其注解风格</li></ul><h3 id="3-2-CGLIB-是什么"><a href="#3-2-CGLIB-是什么" class="headerlink" title="3.2 CGLIB 是什么"></a>3.2 CGLIB 是什么</h3><p>CGLIB（Code Generation Library）是一个字节码生成库，用于在运行时生成类的子类。</p><h4 id="特点：-2"><a href="#特点：-2" class="headerlink" title="特点："></a>特点：</h4><ul><li>运行时生成代理类（字节码生成）</li><li>基于继承（创建目标类的子类）</li><li>不需要接口</li><li>性能较好（比 JDK 动态代理快）</li></ul><h4 id="工作原理："><a href="#工作原理：" class="headerlink" title="工作原理："></a>工作原理：</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 原始类</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// CGLIB 生成的代理类（运行时生成）</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span>$$EnhancerByCGLIB$$xxx <span class="token keyword">extends</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> MethodInterceptor interceptor<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 调用拦截器</span>        interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> methodProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3-AspectJ-是什么"><a href="#3-3-AspectJ-是什么" class="headerlink" title="3.3 AspectJ 是什么"></a>3.3 AspectJ 是什么</h3><p>AspectJ 是一个完整的 AOP 框架，提供：</p><ul><li>切点表达式语言</li><li>字节码织入能力</li><li>注解支持（@Aspect, @Before 等）</li></ul><h3 id="3-4-在-Spring-中的关系"><a href="#3-4-在-Spring-中的关系" class="headerlink" title="3.4 在 Spring 中的关系"></a>3.4 在 Spring 中的关系</h3><pre><code>Spring AOP    ├── 使用 AspectJ 的注解风格 (@Aspect, @Before, @After...)    ├── 使用 AspectJ 的切点表达式 (execution, within...)    ├── 使用 AspectJ 的解析器 (aspectjweaver.jar)    └── 使用两种代理实现：        ├── JDK 动态代理 (基于接口)        └── CGLIB 代理 (基于继承) ← 这里用到 CGLIB</code></pre><h3 id="3-5-代理类命名规则"><a href="#3-5-代理类命名规则" class="headerlink" title="3.5 代理类命名规则"></a>3.5 代理类命名规则</h3><h4 id="JDK-动态代理"><a href="#JDK-动态代理" class="headerlink" title="JDK 动态代理"></a>JDK 动态代理</h4><pre class="line-numbers language-java"><code class="language-java">$Proxy0$Proxy1$Proxy2<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="CGLIB-代理"><a href="#CGLIB-代理" class="headerlink" title="CGLIB 代理"></a>CGLIB 代理</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// CGLIB 代理生成的类名格式</span>原始类名$$EnhancerByCGLIB$$hashcode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="Spring-AOP-使用-CGLIB"><a href="#Spring-AOP-使用-CGLIB" class="headerlink" title="Spring AOP 使用 CGLIB"></a>Spring AOP 使用 CGLIB</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Spring AOP 使用 CGLIB 时的类名格式</span>原始类名$$EnhancerBySpringCGLIB$$hashcode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="3-6-总结"><a href="#3-6-总结" class="headerlink" title="3.6 总结"></a>3.6 总结</h3><ul><li><strong>AspectJ</strong>：提供语法和解析器（告诉 Spring 切哪里）</li><li><strong>CGLIB</strong>：生成代理类（告诉 Spring 怎么切）</li></ul><p>两者在 Spring AOP 中配合使用，但职责不同。</p><hr><h2 id="4-代理类的生成时机"><a href="#4-代理类的生成时机" class="headerlink" title="4. 代理类的生成时机"></a>4. 代理类的生成时机</h2><h3 id="4-1-核心答案"><a href="#4-1-核心答案" class="headerlink" title="4.1 核心答案"></a>4.1 核心答案</h3><p><strong>代理类在 Spring 启动时（Bean 创建时）生成，不是在实际调用时生成</strong></p><h3 id="4-2-详细流程"><a href="#4-2-详细流程" class="headerlink" title="4.2 详细流程"></a>4.2 详细流程</h3><h4 id="阶段1：Spring-启动时（Bean-创建阶段）"><a href="#阶段1：Spring-启动时（Bean-创建阶段）" class="headerlink" title="阶段1：Spring 启动时（Bean 创建阶段）"></a>阶段1：Spring 启动时（Bean 创建阶段）</h4><pre><code>1. 扫描所有 @Component、@Service 等注解的类   ↓2. 识别带 @Transactional 的类和方法   ↓3. 创建 Bean 定义（BeanDefinition）   ↓4. 检查是否需要代理   ↓5. 创建代理对象（此时就生成了！）   ↓6. 将代理对象放入容器</code></pre><h4 id="阶段2：实际调用时（运行时）"><a href="#阶段2：实际调用时（运行时）" class="headerlink" title="阶段2：实际调用时（运行时）"></a>阶段2：实际调用时（运行时）</h4><pre><code>1. 从容器获取 Bean（已经是代理对象了！）   ↓2. 调用方法   ↓3. 代理对象拦截调用   ↓4. TransactionInterceptor 处理</code></pre><h3 id="4-3-完整时序图"><a href="#4-3-完整时序图" class="headerlink" title="4.3 完整时序图"></a>4.3 完整时序图</h3><pre><code>Spring 启动阶段（Bean 创建时）│├─ 1. 扫描所有 Bean│   └─ 发现 @Service class UserService│├─ 2. 检查是否需要代理│   └─ 发现 @Transactional 注解│├─ 3. 创建代理对象（此时生成！）│   ├─ 使用 CGLIB 或 JDK 动态代理│   ├─ 生成：UserService$$EnhancerBySpringCGLIB$$xxx│   └─ 添加 TransactionInterceptor│└─ 4. 将代理对象放入容器    └─ 容器中存储的是代理对象，不是原始对象─────────────────────────────────────────运行时（实际调用时）│├─ 1. 从容器获取 Bean│   └─ 返回的是代理对象（已存在）│├─ 2. 调用方法│   └─ userService.saveUser(user)│├─ 3. 代理对象拦截│   └─ UserService$$EnhancerBySpringCGLIB$$xxx.saveUser()│├─ 4. TransactionInterceptor.invoke()│   ├─ 获取事务属性│   ├─ 创建/获取事务│   ├─ 调用原始方法│   └─ 提交/回滚事务│└─ 5. 返回结果</code></pre><h3 id="4-4-关键点总结"><a href="#4-4-关键点总结" class="headerlink" title="4.4 关键点总结"></a>4.4 关键点总结</h3><ul><li><strong>代理对象生成时机</strong>：Spring 启动时（Bean 创建阶段）</li><li><strong>不是在调用时生成</strong>：调用时只是使用已存在的代理对象</li><li><strong>为什么在启动时生成</strong>：<ul><li>性能：避免每次调用都创建代理</li><li>一致性：同一个 Bean 始终使用同一个代理对象</li><li>容器管理：代理对象作为 Bean 被 Spring 管理</li></ul></li></ul><hr><h2 id="5-事务传播行为详解"><a href="#5-事务传播行为详解" class="headerlink" title="5. 事务传播行为详解"></a>5. 事务传播行为详解</h2><h3 id="5-1-最常用的三个传播行为"><a href="#5-1-最常用的三个传播行为" class="headerlink" title="5.1 最常用的三个传播行为"></a>5.1 最常用的三个传播行为</h3><h4 id="1-REQUIRED（默认，最常用）"><a href="#1-REQUIRED（默认，最常用）" class="headerlink" title="1. REQUIRED（默认，最常用）"></a>1. REQUIRED（默认，最常用）</h4><p><strong>含义</strong>：</p><ul><li>如果当前存在事务，则加入该事务</li><li>如果当前不存在事务，则创建一个新事务</li></ul><p><strong>使用场景</strong>：</p><ul><li>大多数业务方法</li><li>默认行为，无需显式指定</li></ul><p><strong>代码示例</strong>：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> OrderService orderService<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 默认就是 REQUIRED，可以不写</span>    <span class="token annotation punctuation">@Transactional</span>  <span class="token comment" spellcheck="true">// 等同于 @Transactional(propagation = Propagation.REQUIRED)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserAndOrder</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 创建用户</span>        userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 调用另一个事务方法</span>        orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 会加入当前事务</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span>Long userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果从 createUserAndOrder 调用，会加入外层事务</span>        <span class="token comment" spellcheck="true">// 如果单独调用，会创建新事务</span>        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-REQUIRES-NEW（第二常用）"><a href="#2-REQUIRES-NEW（第二常用）" class="headerlink" title="2. REQUIRES_NEW（第二常用）"></a>2. REQUIRES_NEW（第二常用）</h4><p><strong>含义</strong>：</p><ul><li>总是创建一个新事务</li><li>如果当前存在事务，则挂起当前事务，创建新事务</li><li>新事务独立提交或回滚</li></ul><p><strong>使用场景</strong>：</p><ul><li>日志记录（即使主业务失败也要记录）</li><li>审计操作</li><li>需要独立事务的业务</li></ul><p><strong>代码示例</strong>：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> LogService logService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span>Order order<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 主业务逻辑</span>            orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 记录日志（需要独立事务）</span>            logService<span class="token punctuation">.</span><span class="token function">saveLog</span><span class="token punctuation">(</span><span class="token string">"订单创建成功"</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 即使这里回滚，日志也会保存</span>            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogService</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 使用 REQUIRES_NEW，确保日志总是被保存</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRES_NEW<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveLog</span><span class="token punctuation">(</span>String message<span class="token punctuation">,</span> Long orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这个操作会在新事务中执行</span>        <span class="token comment" spellcheck="true">// 即使外层事务回滚，这个也会提交</span>        logMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-NESTED（第三常用）"><a href="#3-NESTED（第三常用）" class="headerlink" title="3. NESTED（第三常用）"></a>3. NESTED（第三常用）</h4><p><strong>含义</strong>：</p><ul><li>如果当前存在事务，则创建一个嵌套事务（保存点）</li><li>如果当前不存在事务，则创建一个新事务</li><li>嵌套事务可以独立回滚，不影响外层事务</li></ul><p><strong>使用场景</strong>：</p><ul><li>批量操作中的单个失败处理</li><li>需要部分回滚的场景</li><li>子操作失败不影响主操作</li></ul><p><strong>代码示例</strong>：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchProcessOrders</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Order<span class="token operator">&gt;</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Order order <span class="token operator">:</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 每个订单处理是嵌套事务</span>                <span class="token function">processSingleOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 单个订单失败不影响其他订单</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"订单处理失败: "</span> <span class="token operator">+</span> order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 嵌套事务回滚，外层事务继续</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 使用 NESTED，创建嵌套事务（保存点）</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>NESTED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processSingleOrder</span><span class="token punctuation">(</span>Order order<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 验证订单</span>        <span class="token function">validateOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 扣减库存</span>        <span class="token function">reduceStock</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 创建订单</span>        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果这里抛异常，只回滚这个嵌套事务</span>        <span class="token comment" spellcheck="true">// 不影响 batchProcessOrders 中的其他订单</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-2-三个传播行为对比"><a href="#5-2-三个传播行为对比" class="headerlink" title="5.2 三个传播行为对比"></a>5.2 三个传播行为对比</h3><table><thead><tr><th>传播行为</th><th>当前有事务</th><th>当前无事务</th><th>回滚影响</th><th>使用频率</th></tr></thead><tbody><tr><td><strong>REQUIRED</strong></td><td>加入事务</td><td>创建新事务</td><td>一起回滚</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>REQUIRES_NEW</strong></td><td>挂起，创建新事务</td><td>创建新事务</td><td>独立回滚</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>NESTED</strong></td><td>创建嵌套事务</td><td>创建新事务</td><td>可独立回滚</td><td>⭐⭐⭐</td></tr></tbody></table><h3 id="5-3-REQUIRES-NEW-和-NESTED-的区别"><a href="#5-3-REQUIRES-NEW-和-NESTED-的区别" class="headerlink" title="5.3 REQUIRES_NEW 和 NESTED 的区别"></a>5.3 REQUIRES_NEW 和 NESTED 的区别</h3><h4 id="REQUIRES-NEW：互不影响（完全独立）"><a href="#REQUIRES-NEW：互不影响（完全独立）" class="headerlink" title="REQUIRES_NEW：互不影响（完全独立）"></a>REQUIRES_NEW：互不影响（完全独立）</h4><ul><li>创建完全独立的新事务</li><li>外层事务回滚 → 不影响内层（内层已独立提交）</li><li>内层事务回滚 → 不影响外层（外层继续执行）</li></ul><h4 id="NESTED：有影响（单向）"><a href="#NESTED：有影响（单向）" class="headerlink" title="NESTED：有影响（单向）"></a>NESTED：有影响（单向）</h4><ul><li>创建嵌套事务（保存点）</li><li>外层回滚 → 影响内层（一起回滚）</li><li>内层回滚 → 不影响外层（回滚到保存点）</li></ul><p><strong>对比表格</strong>：</p><table><thead><tr><th>特性</th><th>REQUIRES_NEW</th><th>NESTED</th></tr></thead><tbody><tr><td>事务关系</td><td>完全独立</td><td>嵌套（保存点）</td></tr><tr><td>外层回滚影响内层</td><td>❌ 不影响（内层已提交）</td><td>✅ 影响（一起回滚）</td></tr><tr><td>内层回滚影响外层</td><td>❌ 不影响（外层继续）</td><td>❌ 不影响（回滚到保存点）</td></tr><tr><td>提交时机</td><td>内层立即提交</td><td>外层提交时一起提交</td></tr><tr><td>使用场景</td><td>日志、审计（必须保存）</td><td>批量操作（部分回滚）</td></tr></tbody></table><hr><h2 id="6-事务隔离级别"><a href="#6-事务隔离级别" class="headerlink" title="6. 事务隔离级别"></a>6. 事务隔离级别</h2><h3 id="6-1-可以设置不同的隔离级别"><a href="#6-1-可以设置不同的隔离级别" class="headerlink" title="6.1 可以设置不同的隔离级别"></a>6.1 可以设置不同的隔离级别</h3><p>每个 <code>@Transactional</code> 注解都可以独立配置自己的隔离级别，互不影响。</p><h3 id="6-2-如何设置不同的隔离级别"><a href="#6-2-如何设置不同的隔离级别" class="headerlink" title="6.2 如何设置不同的隔离级别"></a>6.2 如何设置不同的隔离级别</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 方法1：使用默认隔离级别（通常是 READ_COMMITTED）</span>    <span class="token annotation punctuation">@Transactional</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span>Order order<span class="token punctuation">)</span> <span class="token punctuation">{</span>        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 方法2：使用 READ_UNCOMMITTED（最低隔离级别，性能最好）</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> Isolation<span class="token punctuation">.</span>READ_UNCOMMITTED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quickQuery</span><span class="token punctuation">(</span>Long orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 方法3：使用 READ_COMMITTED（默认，大多数场景）</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> Isolation<span class="token punctuation">.</span>READ_COMMITTED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span>Order order<span class="token punctuation">)</span> <span class="token punctuation">{</span>        orderMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 方法4：使用 REPEATABLE_READ（可重复读）</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> Isolation<span class="token punctuation">.</span>REPEATABLE_READ<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">calculateTotalAmount</span><span class="token punctuation">(</span>Long userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 需要多次读取一致性的场景</span>        List<span class="token operator">&lt;</span>Order<span class="token operator">&gt;</span> orders <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>        BigDecimal total <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Order<span class="token operator">:</span><span class="token operator">:</span>getAmount<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">.</span>ZERO<span class="token punctuation">,</span> BigDecimal<span class="token operator">:</span><span class="token operator">:</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> total<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 方法5：使用 SERIALIZABLE（最高隔离级别，最严格）</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> Isolation<span class="token punctuation">.</span>SERIALIZABLE<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">criticalBalanceUpdate</span><span class="token punctuation">(</span>Long accountId<span class="token punctuation">,</span> BigDecimal amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 关键业务，需要最高级别的隔离</span>        Account account <span class="token operator">=</span> accountMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>accountId<span class="token punctuation">)</span><span class="token punctuation">;</span>        account<span class="token punctuation">.</span><span class="token function">setBalance</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        accountMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-3-五种隔离级别"><a href="#6-3-五种隔离级别" class="headerlink" title="6.3 五种隔离级别"></a>6.3 五种隔离级别</h3><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>性能</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>READ_UNCOMMITTED</strong></td><td>❌ 可能</td><td>❌ 可能</td><td>❌ 可能</td><td>⭐⭐⭐⭐⭐</td><td>统计查询、性能优先</td></tr><tr><td><strong>READ_COMMITTED</strong></td><td>✅ 避免</td><td>❌ 可能</td><td>❌ 可能</td><td>⭐⭐⭐⭐</td><td>大多数业务（默认）</td></tr><tr><td><strong>REPEATABLE_READ</strong></td><td>✅ 避免</td><td>✅ 避免</td><td>❌ 可能</td><td>⭐⭐⭐</td><td>需要多次读取一致</td></tr><tr><td><strong>SERIALIZABLE</strong></td><td>✅ 避免</td><td>✅ 避免</td><td>✅ 避免</td><td>⭐</td><td>关键业务、金融操作</td></tr></tbody></table><h3 id="6-4-隔离级别的实现原理"><a href="#6-4-隔离级别的实现原理" class="headerlink" title="6.4 隔离级别的实现原理"></a>6.4 隔离级别的实现原理</h3><p>虽然数据库有全局隔离级别，但 Spring 可以在每个事务连接上设置不同的隔离级别：</p><pre><code>Spring 事务管理器的工作流程1. 开启事务时，从连接池获取 Connection   ↓2. 为这个 Connection 设置隔离级别   Connection.setTransactionIsolation(Isolation.REPEATABLE_READ)   ↓3. 执行业务方法   ↓4. 提交/回滚事务   ↓5. 归还 Connection 到连接池   （隔离级别会重置为连接池的默认值）</code></pre><p><strong>关键点</strong>：</p><ul><li>每个事务使用独立的数据库连接</li><li>Spring 在事务开始时为连接设置隔离级别</li><li>通过 <code>Connection.setTransactionIsolation()</code> 实现</li><li>事务结束后连接归还连接池</li></ul><h3 id="6-5-注意事项"><a href="#6-5-注意事项" class="headerlink" title="6.5 注意事项"></a>6.5 注意事项</h3><ol><li><strong>隔离级别不能降级</strong>：内层事务不能使用比外层更低的隔离级别</li><li><strong>数据库支持情况</strong>：不同数据库支持的隔离级别不同</li><li><strong>性能考虑</strong>：根据业务需求选择合适的隔离级别</li></ol><hr><h2 id="7-TransactionInterceptor-实现原理"><a href="#7-TransactionInterceptor-实现原理" class="headerlink" title="7. TransactionInterceptor 实现原理"></a>7. TransactionInterceptor 实现原理</h2><h3 id="7-1-TransactionInterceptor-入口"><a href="#7-1-TransactionInterceptor-入口" class="headerlink" title="7.1 TransactionInterceptor 入口"></a>7.1 TransactionInterceptor 入口</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Spring 源码：TransactionInterceptor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> PlatformTransactionManager transactionManager<span class="token punctuation">;</span>    <span class="token keyword">private</span> TransactionAttributeSource transactionAttributeSource<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. 获取目标类和方法</span>        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> targetClass <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">?</span>             AopUtils<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>        Method method <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2. 获取事务属性（从 @Transactional 注解解析）</span>        TransactionAttribute txAttr <span class="token operator">=</span>             transactionAttributeSource<span class="token punctuation">.</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3. 获取事务管理器</span>        PlatformTransactionManager tm <span class="token operator">=</span> <span class="token function">determineTransactionManager</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 4. 创建事务信息（关键：这里处理传播行为）</span>        TransactionInfo txInfo <span class="token operator">=</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>        Object retVal<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 5. 执行业务方法</span>            retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 6. 提交事务</span>            <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 7. 回滚事务</span>            <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 8. 清理事务信息</span>            <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-2-PlatformTransactionManager-获取事务（处理传播行为）"><a href="#7-2-PlatformTransactionManager-获取事务（处理传播行为）" class="headerlink" title="7.2 PlatformTransactionManager 获取事务（处理传播行为）"></a>7.2 PlatformTransactionManager 获取事务（处理传播行为）</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Spring 源码：AbstractPlatformTransactionManager</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractPlatformTransactionManager</span>         <span class="token keyword">implements</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> TransactionStatus <span class="token function">getTransaction</span><span class="token punctuation">(</span>TransactionDefinition definition<span class="token punctuation">)</span>             <span class="token keyword">throws</span> TransactionException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. 获取当前事务（可能为 null）</span>        Object transaction <span class="token operator">=</span> <span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2. 检查当前是否存在事务</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 处理已存在事务的情况（根据传播行为）</span>            <span class="token keyword">return</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 3. 当前不存在事务，需要创建新事务</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>                 TransactionDefinition<span class="token punctuation">.</span>PROPAGATION_REQUIRED <span class="token operator">||</span>               definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>                 TransactionDefinition<span class="token punctuation">.</span>PROPAGATION_REQUIRES_NEW <span class="token operator">||</span>               definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>                 TransactionDefinition<span class="token punctuation">.</span>PROPAGATION_NESTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 挂起当前事务（如果有）</span>            SuspendedResourcesHolder suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 创建新事务</span>                <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span>                     suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> Error ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">resume</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 处理已存在事务的情况（关键方法）</span>    <span class="token keyword">private</span> TransactionStatus <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>            TransactionDefinition definition<span class="token punctuation">,</span>             Object transaction<span class="token punctuation">,</span>             <span class="token keyword">boolean</span> debugEnabled<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// PROPAGATION_REQUIRES_NEW：挂起当前事务，创建新事务</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>                 TransactionDefinition<span class="token punctuation">.</span>PROPAGATION_REQUIRES_NEW<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 挂起当前事务</span>            SuspendedResourcesHolder suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 创建新事务</span>                <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span>                     suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> Error beginEx<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">resumeAfterBeginException</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">,</span> beginEx<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">throw</span> beginEx<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// PROPAGATION_NESTED：创建嵌套事务（保存点）</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>                 TransactionDefinition<span class="token punctuation">.</span>PROPAGATION_NESTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNestedTransactionAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedTransactionNotSupportedException</span><span class="token punctuation">(</span>                    <span class="token string">"Transaction manager does not allow nested transactions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 创建保存点</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useSavepointForNestedTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                DefaultTransactionStatus status <span class="token operator">=</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>                    definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                status<span class="token punctuation">.</span><span class="token function">createAndHoldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> status<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// PROPAGATION_REQUIRED：加入当前事务</span>        <span class="token comment" spellcheck="true">// 验证隔离级别（不能降级）</span>        <span class="token function">validateExistingTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 加入当前事务，不创建新事务</span>        <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>             debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">,</span> newSynchronization<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-3-具体传播行为的实现"><a href="#7-3-具体传播行为的实现" class="headerlink" title="7.3 具体传播行为的实现"></a>7.3 具体传播行为的实现</h3><h4 id="7-3-1-REQUIRED（默认）的实现"><a href="#7-3-1-REQUIRED（默认）的实现" class="headerlink" title="7.3.1 REQUIRED（默认）的实现"></a>7.3.1 REQUIRED（默认）的实现</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// REQUIRED 传播行为的处理逻辑</span><span class="token keyword">private</span> TransactionStatus <span class="token function">handleRequired</span><span class="token punctuation">(</span>        TransactionDefinition definition<span class="token punctuation">,</span>         Object transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果当前存在事务</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 加入当前事务（不创建新事务）</span>        <span class="token function">validateExistingTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>             debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">,</span> newSynchronization<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果当前不存在事务，创建新事务</span>    <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="7-3-2-REQUIRES-NEW-的实现"><a href="#7-3-2-REQUIRES-NEW-的实现" class="headerlink" title="7.3.2 REQUIRES_NEW 的实现"></a>7.3.2 REQUIRES_NEW 的实现</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// REQUIRES_NEW 传播行为的处理逻辑</span><span class="token keyword">private</span> TransactionStatus <span class="token function">handleRequiresNew</span><span class="token punctuation">(</span>        TransactionDefinition definition<span class="token punctuation">,</span>         Object transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果当前存在事务</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. 挂起当前事务</span>        SuspendedResourcesHolder suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 2. 创建新事务（独立事务）</span>            <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span>                 suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> Error beginEx<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 如果创建新事务失败，恢复被挂起的事务</span>            <span class="token function">resumeAfterBeginException</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">,</span> beginEx<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> beginEx<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果当前不存在事务，直接创建新事务</span>    <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 挂起当前事务</span><span class="token keyword">protected</span> <span class="token keyword">final</span> SuspendedResourcesHolder <span class="token function">suspend</span><span class="token punctuation">(</span>Object transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 保存当前事务的所有信息</span>    <span class="token comment" spellcheck="true">// 清理当前线程的事务信息</span>    <span class="token comment" spellcheck="true">// 返回被挂起的事务信息</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 恢复被挂起的事务</span><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">resume</span><span class="token punctuation">(</span>Object transaction<span class="token punctuation">,</span>         SuspendedResourcesHolder resourcesHolder<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 恢复被挂起的事务信息</span>    <span class="token comment" spellcheck="true">// 重新设置到当前线程</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="7-3-3-NESTED-的实现"><a href="#7-3-3-NESTED-的实现" class="headerlink" title="7.3.3 NESTED 的实现"></a>7.3.3 NESTED 的实现</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// NESTED 传播行为的处理逻辑</span><span class="token keyword">private</span> TransactionStatus <span class="token function">handleNested</span><span class="token punctuation">(</span>        TransactionDefinition definition<span class="token punctuation">,</span>         Object transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 检查是否支持嵌套事务</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNestedTransactionAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedTransactionNotSupportedException</span><span class="token punctuation">(</span>            <span class="token string">"Transaction manager does not allow nested transactions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果当前存在事务</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 使用保存点（Savepoint）实现嵌套事务</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useSavepointForNestedTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 创建保存点</span>            DefaultTransactionStatus status <span class="token operator">=</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>                definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 创建并持有保存点</span>            status<span class="token punctuation">.</span><span class="token function">createAndHoldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> status<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 某些事务管理器不支持保存点，创建新事务</span>            <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果当前不存在事务，创建新事务</span>    <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 创建保存点（DataSourceTransactionManager 实现）</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doSetSavepoint</span><span class="token punctuation">(</span>Object savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionException <span class="token punctuation">{</span>    ConnectionHolder conHolder <span class="token operator">=</span> <span class="token punctuation">(</span>ConnectionHolder<span class="token punctuation">)</span>         TransactionSynchronizationManager<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 在数据库连接上创建保存点</span>        Savepoint savepointToUse <span class="token operator">=</span> conHolder<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setSavepoint</span><span class="token punctuation">(</span>savepointName<span class="token punctuation">)</span><span class="token punctuation">;</span>        conHolder<span class="token punctuation">.</span><span class="token function">setSavepoint</span><span class="token punctuation">(</span>savepointToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CannotCreateTransactionException</span><span class="token punctuation">(</span>            <span class="token string">"Could not create JDBC savepoint"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 回滚到保存点</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRollbackToSavepoint</span><span class="token punctuation">(</span>Object savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionException <span class="token punctuation">{</span>    ConnectionHolder conHolder <span class="token operator">=</span> <span class="token punctuation">(</span>ConnectionHolder<span class="token punctuation">)</span>         TransactionSynchronizationManager<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 回滚到保存点</span>        conHolder<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Savepoint<span class="token punctuation">)</span> savepoint<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TransactionSystemException</span><span class="token punctuation">(</span>            <span class="token string">"Could not roll back to JDBC savepoint"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-4-事务提交和回滚的处理"><a href="#7-4-事务提交和回滚的处理" class="headerlink" title="7.4 事务提交和回滚的处理"></a>7.4 事务提交和回滚的处理</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 提交事务</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span>TransactionInfo txInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span><span class="token function">hasTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 提交事务</span>        txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// AbstractPlatformTransactionManager 的提交逻辑</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span>TransactionStatus status<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionException <span class="token punctuation">{</span>    DefaultTransactionStatus defStatus <span class="token operator">=</span> <span class="token punctuation">(</span>DefaultTransactionStatus<span class="token punctuation">)</span> status<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 如果是嵌套事务（有保存点）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">hasSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 只释放保存点，不提交外层事务</span>        status<span class="token punctuation">.</span><span class="token function">releaseHeldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">// 如果是新事务（REQUIRES_NEW 或独立事务）</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 提交事务</span>        <span class="token function">doCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">// 如果是加入的事务（REQUIRED），不提交，等待外层提交</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 不提交，外层事务提交时会一起提交</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-5-完整执行流程示例"><a href="#7-5-完整执行流程示例" class="headerlink" title="7.5 完整执行流程示例"></a>7.5 完整执行流程示例</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. TransactionInterceptor.invoke()</span>        <span class="token comment" spellcheck="true">// 2. createTransactionIfNecessary()</span>        <span class="token comment" spellcheck="true">// 3. tm.getTransaction() -&gt; handleExistingTransaction()</span>        <span class="token comment" spellcheck="true">//    -&gt; 当前无事务，创建新事务</span>        <span class="token comment" spellcheck="true">// 4. 执行业务代码</span>        <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 调用 REQUIRES_NEW</span>        <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 调用 NESTED</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRES_NEW<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. TransactionInterceptor.invoke()</span>        <span class="token comment" spellcheck="true">// 2. createTransactionIfNecessary()</span>        <span class="token comment" spellcheck="true">// 3. tm.getTransaction() -&gt; handleExistingTransaction()</span>        <span class="token comment" spellcheck="true">//    -&gt; 检测到当前有事务</span>        <span class="token comment" spellcheck="true">//    -&gt; suspend(transaction) 挂起外层事务</span>        <span class="token comment" spellcheck="true">//    -&gt; startTransaction() 创建新事务</span>        <span class="token comment" spellcheck="true">// 4. 执行业务代码</span>        <span class="token comment" spellcheck="true">// 5. 提交新事务</span>        <span class="token comment" spellcheck="true">// 6. resume() 恢复外层事务</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>NESTED<span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. TransactionInterceptor.invoke()</span>        <span class="token comment" spellcheck="true">// 2. createTransactionIfNecessary()</span>        <span class="token comment" spellcheck="true">// 3. tm.getTransaction() -&gt; handleExistingTransaction()</span>        <span class="token comment" spellcheck="true">//    -&gt; 检测到当前有事务</span>        <span class="token comment" spellcheck="true">//    -&gt; createAndHoldSavepoint() 创建保存点</span>        <span class="token comment" spellcheck="true">// 4. 执行业务代码</span>        <span class="token comment" spellcheck="true">// 5. 如果成功：releaseHeldSavepoint() 释放保存点</span>        <span class="token comment" spellcheck="true">//    如果失败：rollbackToSavepoint() 回滚到保存点</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-6-关键实现点总结"><a href="#7-6-关键实现点总结" class="headerlink" title="7.6 关键实现点总结"></a>7.6 关键实现点总结</h3><ol><li><p><strong>REQUIRED（默认）</strong></p><ul><li>有事务：加入当前事务</li><li>无事务：创建新事务</li></ul></li><li><p><strong>REQUIRES_NEW</strong></p><ul><li>有事务：挂起当前事务 → 创建新事务 → 提交新事务 → 恢复外层事务</li><li>无事务：创建新事务</li></ul></li><li><p><strong>NESTED</strong></p><ul><li>有事务：创建保存点（Savepoint）→ 失败回滚到保存点，成功释放保存点</li><li>无事务：创建新事务</li></ul></li></ol><h3 id="7-7-核心方法"><a href="#7-7-核心方法" class="headerlink" title="7.7 核心方法"></a>7.7 核心方法</h3><ul><li><code>handleExistingTransaction()</code>：处理已存在事务的情况</li><li><code>suspend()</code>：挂起事务</li><li><code>resume()</code>：恢复事务</li><li><code>createAndHoldSavepoint()</code>：创建保存点</li><li><code>processCommit()</code>：处理提交（区分新事务、加入事务、嵌套事务）</li></ul><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="关键要点"><a href="#关键要点" class="headerlink" title="关键要点"></a>关键要点</h3><ol><li><strong>Spring @Transactional 基于 AOP 实现</strong>，通过代理对象拦截方法调用</li><li><strong>代理对象在 Spring 启动时生成</strong>，不是在实际调用时生成</li><li><strong>Spring AOP 使用 AspectJ 的注解和表达式</strong>，但底层是动态代理（JDK 或 CGLIB）</li><li><strong>CGLIB 是代理实现方式</strong>，AspectJ 提供语法和解析器</li><li><strong>事务传播行为通过 PlatformTransactionManager 实现</strong>，不同传播行为有不同的处理逻辑</li><li><strong>每个事务可以设置不同的隔离级别</strong>，通过 Connection.setTransactionIsolation() 实现</li></ol><h3 id="学习建议"><a href="#学习建议" class="headerlink" title="学习建议"></a>学习建议</h3><ul><li>理解 Spring AOP 和 AspectJ 的区别</li><li>掌握三种常用传播行为的使用场景</li><li>了解代理对象的生成时机</li><li>理解事务传播机制的底层实现原理</li></ul><hr><p><em>本文档整理自 Spring 事务机制相关技术讨论</em></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java NIO Buffer 使用与实现原理</title>
      <link href="/posts/103.html"/>
      <url>/posts/103.html</url>
      
        <content type="html"><![CDATA[<p>📚 微服务容错与流量治理核心机制笔记<br>时间：2025年11月20日</p><p>一、注册中心的心跳机制：为什么需要双向通信？</p><ol><li>客户端 → 注册中心（心跳续约）<br>目的：证明服务实例存活，防止被误剔除。<br>实现：客户端定期（如 Eureka 默认 30s）发送心跳。<br>优点：轻量、简单、注册中心压力小。</li><li>注册中心 → 客户端（主动探测）<br>目的：<br>应对客户端异常退出（如 kill -9）；<br>防止“假活实例”（进程卡死但心跳正常）；<br>提高服务状态准确性。<br>典型实现：<br>Consul：主动 HTTP/TCP 健康检查；<br>Nacos：对持久化实例进行 TCP 探测；<br>ZooKeeper：通过 Session 机制隐式探测。</li><li>为什么 Eureka 不主动探测？<br>设计哲学：AP 系统，优先保证高可用；<br>风险：可能保留“僵尸实例”；<br>应对：可集成 Spring Boot Actuator，让客户端在健康检查失败时主动停止心跳。</li></ol><p>二、Eureka 的自我保护机制（Self-Preservation）</p><ol><li>设计目标<br>防止网络分区或瞬时故障导致大量健康实例被误删，避免雪崩。</li><li>触发条件（默认）<br>每分钟期望心跳数 = 实例数 × 2（因默认 30s 心跳一次）；<br>若实际心跳数 &lt; 期望值 × 85%（renewal-percent-threshold），则进入自我保护模式。</li><li>自我保护期间行为<br>❌ 停止剔除过期实例；<br>✅ 允许新服务注册；<br>⚠️ 暂停集群间数据同步；<br>✅ 继续提供服务发现（返回所有实例，含可能失效的）；<br>🟥 控制台显示红色警告。</li><li>关键配置<br>yaml<br>eureka:<br>server:<br>enable-self-preservation: true # 默认开启（生产勿关！）<br>renewal-percent-threshold: 0.85<br>instance:<br>lease-renewal-interval-in-seconds: 30 # 心跳间隔<br>lease-expiration-duration-in-seconds: 90 # 失效等待时间<br>💡 最佳实践：生产环境务必开启；配合 Actuator 健康检查提升准确性。</li></ol><p>三、Sentinel 核心机制详解</p><ol><li>功能概览<br>✅ 限流（QPS/线程数/关联/链路）<br>✅ 熔断降级（慢调用比例、异常比例）<br>✅ 系统负载保护<br>✅ 热点参数限流<br>✅ 实时监控 + 动态规则（支持 Nacos/Apollo）</li><li>熔断如何工作？<br>Sentinel 自动统计以下指标（基于滑动窗口）：<br>请求总数<br>异常数 / 异常比例<br>平均 RT（响应时间）<br>慢调用比例（耗时 &gt; 阈值的请求占比）<br>熔断策略：<br>类型 触发条件示例</li></ol><hr><p>慢调用比例 10秒内 ≥5 次调用，60% 耗时 &gt; 500ms<br>异常比例 10秒内 ≥5 次调用，错误率 ≥ 50%<br>🔸 注意：只有抛出异常的调用才计入错误；返回错误码不算。<br>3. Sentinel 是轻量级的吗？<br>   ✅ 是！默认在当前线程执行，无额外线程开销；<br>   通过 AOP 式拦截 + 内存滑动窗口统计；<br>   对比 Hystrix 的线程池模型，性能更高、资源占用更少。<br>4. fallback 需要自己实现<br>   java<br>   @SentinelResource(<br>   value = “myService”,<br>   blockHandler = “handleBlocked” // 限流/熔断时调用<br>   )<br>   public String myService() { … }</p><p>public String handleBlocked(BlockException ex) {<br>return “系统繁忙，请稍后再试”;<br>}<br>📌 Sentinel 只负责“拦”，不负责“兜”。</p><p>四、Hystrix vs Sentinel：熔断与限流对比</p><p>能力 Hystrix Sentinel</p><hr><p>熔断（错误率） ✅ 支持 ✅ 支持（+ 慢调用比例）<br>QPS 限流 ❌ 不支持 ✅ 支持<br>并发控制 ✅（线程池 / 信号量） ✅（线程数流控）<br>热点参数限流 ❌ ✅<br>动态规则 困难 ✅（Nacos 等）<br>轻量级（无额外线程） ❌（默认线程池） ✅（默认当前线程）<br>💡 Hystrix = 熔断器 + 隔离器，不是限流器。</p><p>五、JDBC 查询为何无法被线程中断？</p><ol><li>根本原因<br>JDBC 使用阻塞 I/O（socket read/write）；<br>Java 的 Thread.interrupt() 对阻塞 I/O 无效；<br>线程会一直等待数据库返回，直到：<br>查询完成，或<br>socket/database 超时。</li><li>正确中断 JDBC 的方法<br>✅ 方案1：Statement.cancel()<br>驱动向数据库发送取消请求（如 MySQL 的 KILL QUERY）；<br>需持有原 Statement 对象。<br>✅ 方案2：setQueryTimeout(seconds)<br>java<br>PreparedStatement ps = conn.prepareStatement(sql);<br>ps.setQueryTimeout(3); // 最多执行3秒<br>驱动内部启动监控线程，超时后自动调用 cancel()；<br>强烈推荐在所有可能慢的 SQL 上设置！</li></ol><p>六、Hystrix 超时与熔断的真实机制</p><ol><li>熔断 ≠ 线程中断<br>熔断：基于错误率的状态机（CLOSED → OPEN）；<br>进入 OPEN 状态后，直接拒绝请求，不执行 run() 方法；<br>与线程中断无关。</li><li>超时才涉及线程中断（仅线程池模式）<br>主线程调用 future.get(timeout)；<br>超时后：<br>主线程立即走 fallback；<br>同时调用 future.cancel(true) 尝试 interrupt 工作线程；<br>但若 run() 中是 JDBC 查询，interrupt 无效 → 工作线程仍卡住。</li><li>为什么主线程还能返回？<br>主线程和工作线程解耦；<br>主线程只关心“是否在 timeout 内拿到结果”，不等待工作线程真正结束；<br>用户早已收到 fallback 响应，但工作线程仍在后台执行（直到 DB 返回）。</li><li>风险<br>Hystrix 线程池可能被慢查询占满；<br>数据库连接未释放，可能导致连接池耗尽；<br>数据库仍在执行“已取消”的查询，浪费资源。<br>✅ 解决方案：必须配合 setQueryTimeout()，从源头控制查询耗时。</li></ol><p>七、总结与建议</p><p>场景 推荐方案</p><hr><p>服务注册发现 Eureka（AP，高可用） / Nacos（灵活） / Consul（CP，强一致）<br>熔断 + 限流一体化 ✅ Sentinel（轻量、功能全、动态规则）<br>仅需熔断（老系统） Hystrix（注意线程开销）或 Resilience4j<br>数据库防慢查询 所有 SQL 设置 setQueryTimeout() + 监控慢日志<br>生产环境稳定性 注册中心开启自我保护 + 客户端健康检查 + 服务端熔断限流<br>🌟 核心思想：<br>注册中心：宁可多留，不可错删（AP）；<br>流量治理：既要防“太多请求”，也要防“下游太慢”；<br>数据库访问：永远不要信任 SQL 执行时间，必须设超时！</p><p>📝 本笔记可作为微服务容错设计的参考手册。建议结合实际项目配置实践，并持续监控指标（QPS、RT、错误率、线程池状态）。</p><p>✅ 完</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
